# 作業ログ - 2025年10月24日

## 作業概要

デスクトップWebアプリ用のデータベース拡張設計書を作成し、ユーザーからのフィードバックを受けて承認済み設計に更新しました。

---

## 作業内容詳細

### 1. データベース設計書の承認内容反映

#### 1.1 既存テーブル拡張の修正（9テーブル、28カラム）

**承認された追加項目のみを反映**し、不要と判断された項目を削除しました。

##### 削除された項目

| テーブル | 削除されたカラム | 理由 |
|---------|----------------|------|
| **Nurseries** | Theme, Timezone | デスクトップアプリでは不要 |
| **Classes** | GradeLevel, SortOrder, Description, ClassColor | シンプルな年度管理のみで十分 |
| **Children** | PhotoUrl, EmergencyContactName, EmergencyContactPhone, Allergies | 個別の緊急連絡先不要、写真URL不要 |
| **Staff** | PhotoUrl | 写真URL不要 |
| **StaffClassAssignments** | AssignedByUserId | 割り当て者の記録不要 |
| **DailyReports** | ApprovalStatus, ApprovedByUserId, ApprovedAt, RejectionReason | 承認ワークフロー全体が不要 |
| **Photos** | ApprovalStatus, ApprovedByUserId, ApprovedAt, RejectionReason, TaggedChildrenIds | 承認ワークフロー不要、タグ付けは既存PhotoChildrenテーブルを使用 |
| **Announcements** | ScheduledPublishAt, ActualPublishedAt, TargetGradeLevel, TargetClassId, ReadCount, TotalRecipients | 予約配信・配信統計機能不要 |

##### 保持された項目（28カラム）

**1. Nurseries（5カラム）**
- `LastLoginAt DATETIME2` - 最終ログイン日時
- `LoginAttempts INT` - ログイン試行回数（セキュリティ）
- `IsLocked BIT` - アカウントロック状態
- `LockedUntil DATETIME2` - ロック解除日時
- `CurrentAcademicYear INT` - 現在の年度

**2. Classes（2カラム）**
- `AcademicYear INT` - 年度
- `IsActive BIT` - 有効/無効フラグ

**3. Children（5カラム）**
- `GraduationDate DATE` - 卒園日
- `GraduationStatus NVARCHAR(20)` - 卒園ステータス（Graduated/Withdrawn）
- `WithdrawalReason NVARCHAR(200)` - 退園理由
- `BloodType NVARCHAR(5)` - 血液型
- `LastAttendanceDate DATE` - 最終登園日

**4. Staff（7カラム）**
- `HireDate DATE` - 入社日
- `TerminationDate DATE` - 退職日
- `DateOfBirth DATE` - 生年月日
- `Address NVARCHAR(200)` - 住所
- `EmergencyContactName NVARCHAR(100)` - 緊急連絡先名
- `EmergencyContactPhone NVARCHAR(15)` - 緊急連絡先電話番号
- `Notes NVARCHAR(500)` - 備考

**5. StaffClassAssignments（3カラム）**
- `AcademicYear INT` - 年度
- `IsActive BIT` - 有効フラグ
- `AssignedAt DATETIME2` - 割り当て日時

**6. AbsenceNotifications（3カラム）**
- `AcknowledgedByAdminUser BIT` - 管理者による確認フラグ
- `RespondedByStaffId INT` - 対応したスタッフID
- `AcknowledgedByAdminAt DATETIME2` - 管理者確認日時

**7. DailyReports（1カラム）**
- `CreatedByAdminUser BIT` - 管理者作成フラグ

**8. Photos（1カラム）**
- `UploadedByAdminUser BIT` - 管理者アップロードフラグ

**9. Announcements（1カラム）**
- `CreatedByAdminUser BIT` - 管理者作成フラグ

---

#### 1.2 新規テーブルの修正（4テーブル）

**削除されたテーブル**
- **GraduationHistory** - テーブル全体削除（卒園情報はChildrenテーブルで管理）
- **ReportTemplates** - テーブル全体削除（日報テンプレート機能不要）

##### 保持されたテーブルの修正内容

**1. AcademicYears（年度管理）**

削除された項目：
- `TotalChildren INT` - 総園児数
- `TotalClasses INT` - 総クラス数
- `TotalStaff INT` - 総スタッフ数
- `AverageAttendanceRate DECIMAL(5,2)` - 平均出席率
- `CONSTRAINT FK_AcademicYears_Nurseries` - 外部キー制約
- `CONSTRAINT UK_AcademicYears_Nursery_Year` - ユニーク制約

保持されたカラム：
```sql
Id INT IDENTITY(1,1) PRIMARY KEY
NurseryId INT NOT NULL
Year INT NOT NULL
StartDate DATE NOT NULL
EndDate DATE NOT NULL
IsCurrent BIT NOT NULL DEFAULT 0
IsArchived BIT NOT NULL DEFAULT 0
ArchivedAt DATETIME2 NULL
CreatedAt DATETIME2 NOT NULL
UpdatedAt DATETIME2 NULL
```

**2. PromotionHistory（進級履歴）**

削除された項目：
- `CONSTRAINT FK_PromotionHistory_Children` - 外部キー制約

保持されたカラム：
```sql
Id INT IDENTITY(1,1) PRIMARY KEY
NurseryId INT NOT NULL
ChildId INT NOT NULL
FromAcademicYear INT NOT NULL
ToAcademicYear INT NOT NULL
FromClassId NVARCHAR(50) NOT NULL
ToClassId NVARCHAR(50) NOT NULL
PromotedAt DATETIME2 NOT NULL
PromotedByUserId INT NULL
Notes NVARCHAR(200) NULL
CreatedAt DATETIME2 NOT NULL
```

**3. AuditLogs（監査ログ）**

削除された項目：
- `CONSTRAINT FK_AuditLogs_Nurseries` - 外部キー制約

保持されたカラム：
```sql
Id BIGINT IDENTITY(1,1) PRIMARY KEY
NurseryId INT NOT NULL
UserId INT NULL
UserName NVARCHAR(100) NULL
Action NVARCHAR(50) NOT NULL
EntityType NVARCHAR(50) NOT NULL
EntityId NVARCHAR(50) NULL
BeforeValue NVARCHAR(MAX) NULL
AfterValue NVARCHAR(MAX) NULL
IpAddress NVARCHAR(45) NULL
UserAgent NVARCHAR(500) NULL
Timestamp DATETIME2 NOT NULL
```

**4. AttendanceStatistics（出席統計キャッシュ）**

削除された項目：
- `CONSTRAINT FK_AttendanceStatistics_Nurseries` - 外部キー制約
- `CONSTRAINT FK_AttendanceStatistics_Children` - 外部キー制約
- `CONSTRAINT CHK_AttendanceStatistics_Type` - CHECK制約

保持されたカラム：
```sql
Id INT IDENTITY(1,1) PRIMARY KEY
NurseryId INT NOT NULL
ChildId INT NULL
ClassId NVARCHAR(50) NULL
AcademicYear INT NOT NULL
Month INT NULL
Date DATE NULL
StatisticType NVARCHAR(20) NOT NULL
TotalDays INT NOT NULL DEFAULT 0
PresentDays INT NOT NULL DEFAULT 0
AbsentDays INT NOT NULL DEFAULT 0
TardyDays INT NOT NULL DEFAULT 0
AttendanceRate DECIMAL(5,2) NOT NULL DEFAULT 0.00
LastCalculatedAt DATETIME2 NOT NULL
CreatedAt DATETIME2 NOT NULL
UpdatedAt DATETIME2 NULL
```

---

### 2. ストアドプロシージャの削除

**削除されたストアドプロシージャ**
- `sp_GraduateChildren` - 卒園処理（GraduationHistoryテーブル削除に伴い不要）

**保持されたストアドプロシージャ**
- `sp_PromoteChildren` - 進級処理
- `sp_CalculateAttendanceStatistics` - 出席統計計算

---

### 3. Entity Frameworkクラスの削除

**削除されたエンティティクラス**
- `GraduationHistory.cs` - 卒園履歴エンティティ
- `ReportTemplate.cs` - 日報テンプレートエンティティ

**保持されたエンティティクラス**
- `AcademicYear.cs`
- `PromotionHistory.cs`
- `AuditLog.cs`
- `AttendanceStatistic.cs`

---

### 4. マイグレーション順序の更新

**Phase 1: 既存テーブル拡張（依存関係なし）**
1. Nurseries テーブル拡張
2. Classes テーブル拡張
3. Children テーブル拡張
4. Staff テーブル拡張

**Phase 2: 既存テーブル拡張（依存関係あり）**
5. StaffClassAssignments テーブル拡張
6. AbsenceNotifications テーブル拡張
7. DailyReports テーブル拡張
8. Photos テーブル拡張
9. Announcements テーブル拡張

**Phase 3: 新規テーブル作成（基本）**
10. AcademicYears テーブル作成
11. AuditLogs テーブル作成

**Phase 4: 新規テーブル作成（履歴・集計系）**
12. PromotionHistory テーブル作成
13. AttendanceStatistics テーブル作成

---

## 最終的な設計サマリー

### 既存テーブル拡張（9テーブル、28カラム）

| テーブル | 追加カラム数 | 主な目的 |
|---------|------------|---------|
| Nurseries | 5 | ログイン認証、セキュリティ、年度管理 |
| Classes | 2 | 年度管理、有効/無効フラグ |
| Children | 5 | 卒園管理、血液型、出席記録 |
| Staff | 7 | 詳細情報、入退社管理、緊急連絡先 |
| StaffClassAssignments | 3 | 年度別クラス割り当て |
| AbsenceNotifications | 3 | 管理者確認、スタッフ対応記録 |
| DailyReports | 1 | 管理者作成記録 |
| Photos | 1 | 管理者アップロード記録 |
| Announcements | 1 | 管理者作成記録 |

### 新規テーブル作成（4テーブル）

| テーブル名 | 主な目的 |
|-----------|---------|
| AcademicYears | 年度管理、年度切り替え |
| PromotionHistory | 進級履歴の記録 |
| AuditLogs | 操作ログ、セキュリティ監査 |
| AttendanceStatistics | 出席統計の高速化 |

---

## 重要な設計判断

### 1. 外部キー制約の削除理由
- Entity Framework Coreで手動JOIN管理を行うため、データベース側の外部キー制約は不要
- プロジェクト全体の方針として「ナビゲーションプロパティなし」のアプローチを採用

### 2. 承認ワークフローの不要化
- デスクトップアプリは園の管理者が使用するため、日報・写真の承認プロセスは不要
- 管理者が代理作成したかどうかのフラグ（CreatedByAdminUser, UploadedByAdminUser）のみ保持

### 3. 統計データの簡素化
- AcademicYearsテーブルから集計データ（総園児数、総クラス数等）を削除
- 必要に応じてクエリで動的に計算する方針

### 4. 卒園管理のシンプル化
- GraduationHistoryテーブルを削除
- Childrenテーブルの以下のカラムで卒園情報を管理：
  - `GraduationDate` - 卒園日
  - `GraduationStatus` - 卒園ステータス（Graduated/Withdrawn）
  - `WithdrawalReason` - 退園理由
  - `LastAttendanceDate` - 最終登園日

---

## 次のステップ

データベース拡張設計が完了しました。次は以下のいずれかに進むことを推奨：

1. **マイグレーションスクリプトの実装**
   - Entity Framework Core マイグレーションファイルの作成
   - SQL Serverへの適用

2. **API設計書の作成**
   - デスクトップアプリ専用エンドポイントの定義
   - 認証・認可の仕様策定

3. **Entity Framework Core のDbContext更新**
   - 新しいエンティティクラスの追加
   - DbContextへのDbSet追加
   - OnModelCreatingでの設定追加

---

## 修正したファイル

### `docs/desktop/database-design.md`
- 既存テーブル拡張セクション（1.1〜1.9）の修正
- 新規テーブル作成セクション（2.1〜2.4）の修正
- ストアドプロシージャセクション（6.1〜6.2）の修正
- Entity Frameworkエンティティセクション（7.1〜7.4）の修正
- マイグレーション順序セクション（3）の修正
- サマリーセクション（8.1〜8.2）の修正
- 概要セクションの更新

---

## 作業時間

約1.5時間

## 作業者メモ

- ユーザーからの明確なフィードバックにより、設計が大幅に簡素化されました
- 不要な機能（承認ワークフロー、配信予約等）を削除したことで、実装難易度が下がりました
- 外部キー制約なしの設計により、Entity Frameworkの既存パターンと整合性が取れています
- 次回セッションではAPI設計またはマイグレーション実装に進むことが望ましいです
