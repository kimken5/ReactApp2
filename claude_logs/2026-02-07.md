# 作業ログ - 2026年2月7日

## 作業概要

カレンダー画面で休日保育日が表示されない不具合を調査し、タイムゾーン変換の問題を発見。プロジェクト全体でタイムゾーン問題を引き起こす可能性のある箇所を特定し、高優先度の修正を完了。

---

## 実施した作業

### 1. 休日保育日表示不具合の調査と修正

#### 問題の発見
- **不具合内容**: カレンダー画面(週表示)で休日保育日が正しく表示されない
- **データベース状況**: NurseryDayTypesテーブルに10件のHolidayCareレコードが存在
  - 2026-01-31, 2026-02-01, 2026-02-07, 2026-02-14, 2026-02-21, 2026-02-28, 2026-03-07, 2026-03-14, 2026-03-21, 2026-04-04
- **実際の表示**: 2件のみ表示(2026-01-31, 2026-02-01)
- **欠落データ**: 2026-02-07(土曜日)のデータが取得されていない

#### 原因分析

**コンソールログの確認**:
```
[NurseryDayType] Loading data: { startDate: "2026-01-31", endDate: "2026-02-06", viewMode: "week" }
[NurseryDayType] Data loaded: { count: 2, dates: ['2026-01-31', '2026-02-01'] }
```

**根本原因**: `toISOString().split('T')[0]`によるタイムゾーン変換
- JavaScript の `toISOString()` は常にUTC時刻に変換
- JST(UTC+9)の日付がUTCに変換されると、9時間前(実質1日前)にずれる
- 例: JST 2026-02-07 00:00:00 → UTC 2026-02-06 15:00:00 → `"2026-02-06"`
- 結果: 週表示の終了日が土曜日(2026-02-07)ではなく金曜日(2026-02-06)になる

#### 修正内容

**ファイル**: `reactapp.client/src/desktop/pages/CalendarPage.tsx`

**修正前**:
```typescript
const startDateStr = startDate.toISOString().split('T')[0];
const endDateStr = endDate.toISOString().split('T')[0];
```

**修正後**:
```typescript
// ローカルタイムゾーン(JST)で日付をフォーマット
const formatLocalDate = (date: Date): string => {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
};

const startDateStr = formatLocalDate(startDate);
const endDateStr = formatLocalDate(endDate);
```

**検証結果**:
```
[NurseryDayType] Loading data: { startDate: "2026-01-31", endDate: "2026-02-07", viewMode: "week" }
[NurseryDayType] Data loaded: { count: 3, dates: ['2026-01-31', '2026-02-01', '2026-02-07'] }
```
→ 土曜日(2026-02-07)のデータも正しく取得されることを確認

---

### 2. プロジェクト全体のタイムゾーン問題調査

#### 調査方法
`toISOString().split('T')[0]`パターンをプロジェクト全体で検索し、影響範囲を分析。

#### 検出されたファイル一覧(16ファイル、合計39箇所)

**🔴 高優先度: 日付範囲クエリ系(データ欠落リスク)**
1. `CalendarPage.tsx` (デスクトップ版) - 2箇所(イベント取得、休園日取得)
2. `Calendar.tsx` (親アプリ) - 2箇所(カレンダーイベント取得)
3. `DailyMenusPage.tsx` - 2箇所(献立データ取得、カレンダーグリッド表示)
4. `NurseryDayTypeDialog.tsx` - 2箇所(1年前〜1年後のデータ取得、初期日付)
5. `AttendanceReportPage.tsx` - 2箇所(30日間の出欠統計初期日付範囲)

**🟡 中優先度: 日付選択・ナビゲーション系**
6. `AttendancePage.tsx` - 4箇所(初期日付、5日間範囲計算、日付ナビゲーション、max属性)
7. `InfantRecordsPage.tsx` - 4箇所(初期日付、日付ナビゲーション、max属性)
8. `ClassTemperatureBulkPage.tsx` - 4箇所(初期日付、日付ナビゲーション、max属性)
9. `DailyMenuFormPage.tsx` - 3箇所(初期日付、日付ピッカー)

**🟢 低優先度: デフォルト値・制約系**
10. `EventFormModal.tsx` - 1箇所(イベント作成のデフォルト日付)
11. `DashboardPage.tsx` - 2箇所(ダッシュボードの今日の日付表示)
12. `DailyReportFormPage.tsx` - 5箇所(日報のデフォルト日付、max属性)
13. `AnnouncementFormPage.tsx` - 1箇所(お知らせのスケジュール日付)
14. `ParentFormPage.tsx` - 1箇所(保護者の生年月日フォーマット)
15. `StaffFormPage.tsx` - 1箇所(職員の生年月日フォーマット)
16. `EntryExitLogsPage.tsx` - 1箇所(CSVファイル名の日付)
17. `AcademicYearCreate.tsx` - 1箇所(学年度の開始日デフォルト値)

**⚪ 影響なし**
- `CalendarPage.tsx` (デモデータ部分) - デモモード専用なので実データに影響なし

---

### 3. 共通ユーティリティの作成

タイムゾーン問題を根本的に解決するため、共通のユーティリティ関数を作成。

**ファイル**: `reactapp.client/src/utils/dateUtils.ts` (新規作成)

**実装内容**:
```typescript
/**
 * 日付ユーティリティ関数
 * タイムゾーン変換の問題を避けるための共通関数
 */

/**
 * ローカルタイムゾーン(JST)で日付をフォーマット
 * toISOString()はUTCに変換するため、日付がずれる問題を回避
 */
export function formatLocalDate(date: Date): string {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

/**
 * 今日の日付をローカルタイムゾーンで取得
 */
export function getTodayLocal(): string {
  return formatLocalDate(new Date());
}

/**
 * 指定した日数前/後の日付を取得
 */
export function addDays(date: Date | string, days: number): string {
  const d = typeof date === 'string' ? new Date(date) : new Date(date);
  d.setDate(d.getDate() + days);
  return formatLocalDate(d);
}

/**
 * 指定した年数前/後の日付を取得
 */
export function addYears(date: Date | string, years: number): string {
  const d = typeof date === 'string' ? new Date(date) : new Date(date);
  d.setFullYear(d.getFullYear() + years);
  return formatLocalDate(d);
}
```

**設計思想**:
- UTCへの変換を完全に回避
- ローカルタイムゾーン(JST)の値を直接取得
- 日付計算のヘルパー関数を提供(`addDays`, `addYears`)
- JSDocコメントで使用方法を明示

---

### 4. 高優先度ファイルの修正

データ欠落リスクのある日付範囲クエリ系のファイルを優先的に修正。

#### 修正ファイル一覧

**1. CalendarPage.tsx (デスクトップ版カレンダー)**
- **修正箇所**: Line 126-127(イベント取得), Line 177-178(休園日取得)
- **修正内容**: 
  - `formatLocalDate`をインポート
  - `toISOString().split('T')[0]` → `formatLocalDate(date)`に置換
- **影響**: イベントと休園日・休日保育のデータ取得が正確になる

**2. Calendar.tsx (親アプリカレンダー)**
- **修正箇所**: Line 162-163(カレンダーイベント取得)
- **修正内容**: 同上
- **影響**: 親アプリのカレンダー表示が正確になる

**3. DailyMenusPage.tsx (献立カレンダー)**
- **修正箇所**: Line 38-39(月間献立取得), Line 259(カレンダーグリッド表示)
- **修正内容**: 
  - `formatLocalDate`をインポート
  - 日付範囲計算と表示の両方を修正
- **影響**: 月末の献立データが欠落しなくなる

**4. NurseryDayTypeDialog.tsx (休園日・休日保育設定)**
- **修正箇所**: Line 54-55(1年前〜1年後のデータ取得), Line 79(初期日付)
- **修正内容**: 
  - `formatLocalDate`, `addYears`をインポート
  - 年数計算を簡略化: `addYears(today, -1)`, `addYears(today, 1)`
- **影響**: ダイアログで表示される休園日・休日保育のデータ範囲が正確になる

**5. AttendanceReportPage.tsx (出欠統計)**
- **修正箇所**: Line 46-47(30日間の初期日付範囲)
- **修正内容**: 
  - `formatLocalDate`, `getTodayLocal`, `addDays`をインポート
  - 日付計算を簡略化: `getTodayLocal()`, `addDays(new Date(), -30)`
- **影響**: 出欠統計の初期表示日付範囲が正確になる

#### 修正パターンの統一

**Before(問題のあるコード)**:
```typescript
const date = new Date();
const dateStr = date.toISOString().split('T')[0]; // UTCに変換されてしまう
```

**After(修正後のコード)**:
```typescript
import { formatLocalDate, getTodayLocal, addDays, addYears } from '../../utils/dateUtils';

// パターン1: 単純なフォーマット
const dateStr = formatLocalDate(new Date());

// パターン2: 今日の日付
const today = getTodayLocal();

// パターン3: 日数計算
const thirtyDaysAgo = addDays(new Date(), -30);

// パターン4: 年数計算
const oneYearLater = addYears(new Date(), 1);
```

---

### 5. ドキュメント作成

修正内容と今後の対応方針をドキュメント化。

**ファイル**: `claudedocs/timezone-fix-summary.md` (新規作成)

**記載内容**:
- 問題の概要と具体例
- 解決策(共通ユーティリティ)
- 修正済みファイル一覧(優先度別)
- 修正パターンのBefore/After
- 検証方法
- 今後の対応(中優先度・低優先度ファイル)
- 新規コード作成時の注意点

---

## 技術的な詳細

### タイムゾーン変換の仕組み

**問題の根本原因**:
- `toISOString()`は常にUTC時刻に変換する
- 日本はJST(UTC+9)のため、9時間の時差が発生
- 深夜0時の日付がUTCでは前日15時になる

**具体例**:
```javascript
// JST: 2026-02-07 00:00:00
const date = new Date(2026, 1, 7, 0, 0, 0);

// 問題のあるコード
date.toISOString(); // "2026-02-06T15:00:00.000Z" ← 前日になる
date.toISOString().split('T')[0]; // "2026-02-06" ← 1日前

// 正しいコード
formatLocalDate(date); // "2026-02-07" ← 正しい日付
```

### 影響範囲の分類基準

**🔴 高優先度(データ欠落リスク)**:
- 日付範囲をクエリパラメータとしてAPIに送信
- 範囲のずれによりデータが取得できない
- ユーザーに直接影響

**🟡 中優先度(機能への影響)**:
- 日付選択やナビゲーション機能
- 表示される日付がずれる可能性
- UX的に問題

**🟢 低優先度(一貫性の問題)**:
- デフォルト値やmax属性
- 機能的には問題ないが、一貫性のために修正が望ましい

---

## 成果物

### 新規作成ファイル
1. `reactapp.client/src/utils/dateUtils.ts` - 共通ユーティリティ
2. `claudedocs/timezone-fix-summary.md` - 修正サマリー
3. `claude_logs/2026-02-07.md` - 本作業ログ(このファイル)

### 修正ファイル
1. `reactapp.client/src/desktop/pages/CalendarPage.tsx` - デスクトップ版カレンダー
2. `reactapp.client/src/components/calendar/Calendar.tsx` - 親アプリカレンダー
3. `reactapp.client/src/desktop/pages/DailyMenusPage.tsx` - 献立カレンダー
4. `reactapp.client/src/desktop/components/NurseryDayTypeDialog.tsx` - 休園日設定ダイアログ
5. `reactapp.client/src/desktop/pages/AttendanceReportPage.tsx` - 出欠統計

---

## 動作検証

### 検証方法
1. フロントエンド開発サーバー起動: `npm run dev` (https://localhost:5173)
2. バックエンドサーバー起動: `dotnet run --launch-profile https` (https://localhost:7118)
3. カレンダー画面で週表示を確認
4. ブラウザのコンソールログを確認

### 検証結果

**修正前**:
```
[NurseryDayType] Loading data: { startDate: "2026-01-31", endDate: "2026-02-06", viewMode: "week" }
[NurseryDayType] Data loaded: { count: 2, dates: ['2026-01-31', '2026-02-01'] }
```
- 土曜日(2026-02-07)のデータが取得されていない ❌

**修正後**:
```
[NurseryDayType] Loading data: { startDate: "2026-01-31", endDate: "2026-02-07", viewMode: "week" }
[NurseryDayType] Data loaded: { count: 3, dates: ['2026-01-31', '2026-02-01', '2026-02-07'] }
```
- 土曜日(2026-02-07)のデータも正しく取得される ✅
- データベースの全10件中、表示範囲内の3件が正しく取得される ✅

### HMR(Hot Module Replacement)の確認
Vite開発サーバーのログで、すべての修正ファイルが正常にHMR更新されたことを確認:
```
[vite] hmr update /src/desktop/pages/CalendarPage.tsx
[vite] hmr update /src/components/calendar/Calendar.tsx
[vite] hmr update /src/desktop/pages/DailyMenusPage.tsx
[vite] hmr update /src/desktop/components/NurseryDayTypeDialog.tsx
[vite] hmr update /src/desktop/pages/AttendanceReportPage.tsx
```

---

## 今後の対応

### 中優先度ファイルの修正(推奨)
日付選択・ナビゲーション系のコンポーネントは、表示される日付がずれる可能性があるため、修正が推奨されます。

**対象ファイル**:
- `AttendancePage.tsx` (4箇所)
- `InfantRecordsPage.tsx` (4箇所)
- `ClassTemperatureBulkPage.tsx` (4箇所)
- `DailyMenuFormPage.tsx` (3箇所)

**修正方針**:
- 同様に`dateUtils.ts`のユーティリティ関数を使用
- `toISOString().split('T')[0]` → `formatLocalDate()`に置換
- 日付計算部分は`addDays()`などのヘルパー関数を活用

### 低優先度ファイルの修正(任意)
デフォルト値やmax属性など、機能的には問題ないが一貫性のために修正が望ましい箇所。

**対象ファイル**:
- `EventFormModal.tsx`, `DashboardPage.tsx`, `DailyReportFormPage.tsx`, `AnnouncementFormPage.tsx`, `ParentFormPage.tsx`, `StaffFormPage.tsx`, `EntryExitLogsPage.tsx`, `AcademicYearCreate.tsx`

**修正方針**:
- 必要に応じて修正
- コードレビュー時に気づいたら修正

### 新規コード作成時の注意

**禁止パターン**:
```typescript
❌ date.toISOString().split('T')[0]
```

**推奨パターン**:
```typescript
✅ formatLocalDate(date)
✅ getTodayLocal()
✅ addDays(date, days)
✅ addYears(date, years)
```

**理由**: UTCタイムゾーン変換による日付ずれを防ぐため

---

## まとめ

### 完了した作業 ✅
1. ✅ 休日保育日表示不具合の原因特定と修正
2. ✅ プロジェクト全体のタイムゾーン問題の調査(16ファイル、39箇所検出)
3. ✅ 共通ユーティリティ(`dateUtils.ts`)の作成
4. ✅ 高優先度ファイル(5ファイル)の修正完了
5. ✅ 修正内容のドキュメント化
6. ✅ 動作検証(カレンダー画面で土曜日データの取得確認)

### 保留事項 ⏳
- 中優先度ファイル(4ファイル、15箇所)の修正
- 低優先度ファイル(8ファイル、12箇所)の修正

### 重要な教訓
- **タイムゾーンを意識した日付処理**: `toISOString()`は常にUTCに変換するため、ローカルタイムゾーンの値を直接取得する必要がある
- **共通ユーティリティの重要性**: 同じ問題が複数箇所で発生している場合、共通関数を作成することで一貫性を保ち、将来のバグを防ぐ
- **優先度の明確化**: データ欠落リスクのある箇所を優先的に修正し、表示系の問題は後回しにする判断が重要

---

## 参考情報

### 関連ドキュメント
- [claudedocs/timezone-fix-summary.md](../claudedocs/timezone-fix-summary.md) - タイムゾーン修正サマリー
- [reactapp.client/src/utils/dateUtils.ts](../reactapp.client/src/utils/dateUtils.ts) - 日付ユーティリティ

### タイムゾーン関連リソース
- [MDN - Date.prototype.toISOString()](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date/toISOString)
- [MDN - Date](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date)
- JST = UTC+9 (Japan Standard Time)

---

**作業時間**: 約2時間  
**修正ファイル数**: 5ファイル(高優先度)  
**新規作成ファイル数**: 3ファイル(ユーティリティ、ドキュメント、ログ)  
**修正コード行数**: 約30行  
**検出した潜在的問題箇所**: 16ファイル、39箇所
