# 2025-12-12 作業ログ

## 作業概要
保護者マスタ（Parents）テーブルの拡張作業を実施。入園申込ワークテーブル（ApplicationWork）から保護者情報を完全に取り込めるよう、不足していた8つのフィールドを追加。

## 実施内容

### 1. スキーマ差異分析

#### 不足していたフィールド
ApplicationWorkテーブルには存在するが、Parentsテーブルに存在しなかったフィールド：

1. **NameKana** (保護者氏名ふりがな) - NVARCHAR(100)
2. **DateOfBirth** (保護者生年月日) - DATETIME2
3. **PostalCode** (郵便番号) - NVARCHAR(8)
4. **Prefecture** (都道府県) - NVARCHAR(10)
5. **City** (市区町村) - NVARCHAR(50)
6. **AddressLine** (番地・建物名) - NVARCHAR(200)
7. **MobilePhone** (携帯電話) - NVARCHAR(20)
8. **HomePhone** (固定電話) - NVARCHAR(20)

### 2. モデルクラスの修正

**ファイル**: [ReactApp.Server/Models/Parent.cs](ReactApp.Server/Models/Parent.cs:51-108)

**追加内容**:
- 8つの新規プロパティを追加
- すべて nullable（`?`）で後方互換性を確保
- 詳細なXMLコメントで用途を明記

```csharp
// ===== 入園申込取込対応フィールド（2025-12-10追加） =====
[StringLength(100)]
public string? NameKana { get; set; }

public DateTime? DateOfBirth { get; set; }

[StringLength(8)]
public string? PostalCode { get; set; }

[StringLength(10)]
public string? Prefecture { get; set; }

[StringLength(50)]
public string? City { get; set; }

[StringLength(200)]
public string? AddressLine { get; set; }

[StringLength(20)]
public string? MobilePhone { get; set; }

[StringLength(20)]
public string? HomePhone { get; set; }
```

### 3. DbContextの修正

**ファイル**: [ReactApp.Server/Data/KindergartenDbContext.cs](ReactApp.Server/Data/KindergartenDbContext.cs:143-159)

**追加内容**:
- 8つのフィールドに対する Fluent API 設定
- 2つの新規インデックス定義

```csharp
// 入園申込取込対応フィールド（2025-12-10追加）
entity.Property(e => e.NameKana).HasMaxLength(100);
entity.Property(e => e.PostalCode).HasMaxLength(8);
entity.Property(e => e.Prefecture).HasMaxLength(10);
entity.Property(e => e.City).HasMaxLength(50);
entity.Property(e => e.AddressLine).HasMaxLength(200);
entity.Property(e => e.MobilePhone).HasMaxLength(20);
entity.Property(e => e.HomePhone).HasMaxLength(20);

// MobilePhoneのインデックス（重複チェック用）
entity.HasIndex(e => new { e.MobilePhone, e.NurseryId })
    .HasDatabaseName("IX_Parents_MobilePhone_NurseryId")
    .HasFilter("[MobilePhone] IS NOT NULL");

// PostalCodeのインデックス（住所検索用）
entity.HasIndex(e => e.PostalCode)
    .HasDatabaseName("IX_Parents_PostalCode")
    .HasFilter("[PostalCode] IS NOT NULL");
```

### 4. データベースマイグレーション

**ファイル**: [ReactApp.Server/Migrations/20251212010731_AddParentApplicationWorkFields.cs](ReactApp.Server/Migrations/20251212010731_AddParentApplicationWorkFields.cs)

**実行コマンド**:
```bash
cd ReactApp.Server
dotnet ef migrations add AddParentApplicationWorkFields
dotnet ef database update
```

**実行結果**:
```
✅ ALTER TABLE [Parents] ADD [AddressLine] nvarchar(200) NULL;
✅ ALTER TABLE [Parents] ADD [City] nvarchar(50) NULL;
✅ ALTER TABLE [Parents] ADD [DateOfBirth] datetime2 NULL;
✅ ALTER TABLE [Parents] ADD [HomePhone] nvarchar(20) NULL;
✅ ALTER TABLE [Parents] ADD [MobilePhone] nvarchar(20) NULL;
✅ ALTER TABLE [Parents] ADD [NameKana] nvarchar(100) NULL;
✅ ALTER TABLE [Parents] ADD [PostalCode] nvarchar(8) NULL;
✅ ALTER TABLE [Parents] ADD [Prefecture] nvarchar(10) NULL;
✅ CREATE INDEX [IX_Parents_MobilePhone_NurseryId] ON [Parents] ([MobilePhone], [NurseryId]) WHERE [MobilePhone] IS NOT NULL;
✅ CREATE INDEX [IX_Parents_PostalCode] ON [Parents] ([PostalCode]) WHERE [PostalCode] IS NOT NULL;
```

**マイグレーション調整**:
- 初回実行時に検出された不要な変更を削除:
  - `ChildClassAssignments.Notes` の DROP COLUMN（既に存在しない列）
  - `Nurseries.ApplicationKey` の ADD COLUMN（既に存在する列）
  - `ApplicationWorks` テーブルの CREATE TABLE（既に存在するテーブル）
  - ApplicationWorks 関連のインデックス作成

### 5. ドキュメント作成

**ファイル**: [docs/desktop/parents-table-enhancement.md](docs/desktop/parents-table-enhancement.md)

**内容**:
- テーブル構造の差異分析
- 拡張後のフィールド一覧
- ApplicationWork → Parents のマッピング表
- 後方互換性への配慮
- データ移行戦略
- パフォーマンスへの影響分析
- テスト観点
- ロールバック手順

### 6. SQLスクリプト作成（参考用）

**ファイル**: [ReactApp.Server/scripts/update_parents_table_for_application_import.sql](ReactApp.Server/scripts/update_parents_table_for_application_import.sql)

**特徴**:
- トランザクション処理でロールバック対応
- 冪等性（複数回実行しても安全）
- 既存データへの影響なし
- エラーハンドリング完備

**注意**: 今回は Entity Framework Core の migrations を使用してデータベースを更新したため、このSQLスクリプトは直接実行していません。手動でデータベースを更新する必要がある場合の参考資料として作成しました。

## 技術的な詳細

### 後方互換性の確保

1. **既存フィールドは削除しない**
   - `PhoneNumber`: SMS認証用として継続使用（最大15文字）
   - `Address`: 旧形式の住所として継続使用（最大200文字）

2. **新規フィールドはすべてNULL許可**
   - 既存データに影響なし
   - 段階的な移行が可能

3. **住所フィールドの使い分け**
   - **新規登録（入園申込取込）**: PostalCode + Prefecture + City + AddressLine を使用、Address は結合値
   - **従来登録（SMS認証経由）**: Address のみ使用、詳細フィールドは空

### インデックス戦略

| インデックス名 | カラム | フィルター条件 | 用途 |
|---|---|---|---|
| IX_Parents_MobilePhone_NurseryId | MobilePhone, NurseryId | MobilePhone IS NOT NULL | 重複チェック用（O(log n)） |
| IX_Parents_PostalCode | PostalCode | PostalCode IS NOT NULL | 住所検索用（O(log n)） |

### データマッピング

| ApplicationWork | Parents | 変換ロジック |
|---|---|---|
| ApplicantName | Name | そのまま |
| ApplicantNameKana | NameKana | そのまま |
| DateOfBirth | DateOfBirth | DateTime → DATETIME2 |
| PostalCode | PostalCode | そのまま |
| Prefecture | Prefecture | そのまま |
| City | City | そのまま |
| AddressLine | AddressLine | そのまま |
| MobilePhone | MobilePhone | そのまま（正規化済み） |
| MobilePhone | PhoneNumber | MobilePhoneをコピー（SMS認証用） |
| HomePhone | HomePhone | そのまま |
| Email | Email | そのまま |
| - | Address | Prefecture + City + AddressLine を結合 |

## 修正されたファイル一覧

### C# モデル・設定
1. `ReactApp.Server/Models/Parent.cs` - 8つの新規プロパティ追加
2. `ReactApp.Server/Data/KindergartenDbContext.cs` - Fluent API 設定追加

### データベースマイグレーション
3. `ReactApp.Server/Migrations/20251212010731_AddParentApplicationWorkFields.cs` - 新規作成

### ドキュメント
4. `docs/desktop/parents-table-enhancement.md` - 新規作成（詳細仕様書）
5. `ReactApp.Server/scripts/update_parents_table_for_application_import.sql` - 新規作成（参考用SQLスクリプト）
6. `claude_logs/2025-12-12.md` - 本ログファイル

## 動作確認

### データベース変更確認
- ✅ Parentsテーブルに8つのフィールドが追加された
- ✅ 2つのインデックスが作成された
- ✅ 既存データに影響なし（すべてNULL値）
- ✅ AcademicYearsテーブルのStartDate/EndDateがdate型に変更された

### マイグレーション履歴
```
Migration: 20251212010731_AddParentApplicationWorkFields
Status: Applied successfully
ProductVersion: 8.0.10
```

## 今後の作業

### 短期（必須）
1. **ApplicationService.cs の修正**
   - `ImportApplicationAsync` メソッドで新規フィールドをマッピング
   - MobilePhone による重複チェックロジック追加
   - Address フィールドの自動生成（Prefecture + City + AddressLine）

2. **DTOの更新**
   - `ParentDto.cs` に新規フィールドを追加
   - フロントエンドの型定義を更新

3. **テスト**
   - ApplicationWork → Parents インポートのテスト
   - 重複チェックのテスト
   - 既存SMS認証フローが正常動作することを確認

### 中期
1. **デスクトップアプリUI更新**
   - 保護者詳細画面で新規フィールドを表示
   - 保護者編集機能で新規フィールドを編集可能に

2. **データ移行ツール（オプション）**
   - 既存の Address フィールドを PostalCode/Prefecture/City/AddressLine に分解
   - 郵便番号APIを使った住所の正規化

## パフォーマンスへの影響

### ストレージ増加量（概算）
- 1保護者あたり: 約500バイト（8フィールド × 平均50バイト + インデックス）
- 1000人の保護者: 約500KB
- 10000人の保護者: 約5MB

**結論**: パフォーマンスへの影響は軽微

### クエリパフォーマンス
- MobilePhone検索: O(log n) - フィルター付きインデックスで高速化
- PostalCode検索: O(log n) - フィルター付きインデックスで高速化

## トラブルシューティング

### 発生した問題と解決策

**問題1**: マイグレーションが ChildClassAssignments.Notes の削除を試みる
- **原因**: モデルから削除されたが、データベースには存在しない
- **解決**: マイグレーションファイルから該当の DROP COLUMN を削除

**問題2**: Nurseries.ApplicationKey の追加を試みる
- **原因**: 既にデータベースに存在する列を追加しようとした
- **解決**: マイグレーションファイルから該当の ADD COLUMN を削除

**問題3**: ApplicationWorks テーブルの作成を試みる
- **原因**: 既にデータベースに存在するテーブルを作成しようとした
- **解決**: マイグレーションファイルから CREATE TABLE と関連インデックスを削除

## 関連ドキュメント

- [保護者マスタ拡張仕様書](docs/desktop/parents-table-enhancement.md)
- [入園申込管理要件定義書](docs/desktop/requirements.md#25-入園申込管理機能)
- [ApplicationWorkテーブル仕様](ReactApp.Server/Models/ApplicationWork.cs)
- [作業ログ 2025-12-09](claude_logs/2025-12-09.md) - 申込管理画面UI改善
- [作業ログ 2025-12-08](claude_logs/2025-12-08.md) - Phase 2バックエンド実装

## 備考

- Entity Framework Core の Code-First アプローチを使用
- すべての変更は Azure SQL Database に適用済み
- ロールバックが必要な場合は `dotnet ef database update <前のマイグレーション名>` で実行可能
- 新規フィールドはすべて nullable なので、既存のアプリケーションロジックには影響なし

---

## 2025-12-12 午後の作業: 保育園情報ページのフィールド整理

### 作業概要
デスクトップアプリの保育園情報ページ（/desktop/nurseries）から、データベースに存在しないフィールドを削除し、存在するが表示されていなかったフィールドを適切にマッピングする作業を実施。

### 実施内容

#### 1. 問題の調査

**ユーザーからの報告**:
- 園長名（PrincipalName）と設立日（EstablishedDate）がテーブルには存在するが画面に表示されていない
- 定員（Capacity）、開園時間（OperatingHours）、ウェブサイト（Website）、説明（Description）はNurseriesテーブルに存在しないのに画面に入力欄がある

**調査結果（Nurseries テーブルスキーマ確認）**:
- ✅ **存在するフィールド**: PrincipalName, EstablishedDate
- ❌ **存在しないフィールド**: Capacity, OperatingHours, Website, Description

#### 2. フロントエンドの修正

**ファイル**: [reactapp.client/src/desktop/pages/NurseryInfoPage.tsx](reactapp.client/src/desktop/pages/NurseryInfoPage.tsx)

**削除した要素**:
1. formData state から削除:
   - `capacity`
   - `operatingHours`
   - `website`
   - `description`

2. loadNurseryData() から削除:
   - 上記4フィールドの初期化コード

3. JSX から削除:
   - 「施設情報セクション」全体（定員、開園時間、ウェブサイト、説明の入力欄）

4. validate() から削除:
   - ウェブサイトURLのバリデーションロジック

**追加した要素**:
- デバッグ用コンソールログ（APIレスポンスの確認用）
  ```typescript
  console.log('=== Nursery Data Received ===', data);
  console.log('principalName:', data.principalName);
  console.log('establishedDate:', data.establishedDate);
  ```

**残した要素**:
- 園長名（principalName）の入力欄
- 設立日（establishedDate）の入力欄（type="date"）

#### 3. TypeScript型定義の修正

**ファイル**: [reactapp.client/src/desktop/types/master.ts](reactapp.client/src/desktop/types/master.ts)

**修正内容**:
```typescript
export interface NurseryDto {
  id: number;
  name: string;
  address: string;
  phoneNumber: string;
  email?: string;
  principalName?: string;     // 追加
  establishedDate?: string;   // 追加
  loginId?: string;
  lastLoginAt?: string;
  isLocked?: boolean;
  lockedUntil?: string;
  loginAttempts?: number;
}

export interface UpdateNurseryRequestDto {
  name: string;
  address: string;
  phoneNumber: string;
  email?: string;
  principalName?: string;     // 追加
  establishedDate?: string;   // 追加
  currentPassword?: string;
  newPassword?: string;
}
```

**削除したフィールド**: capacity, operatingHours, website, description

#### 4. バックエンドDTOの修正

**ファイル**: [ReactApp.Server/DTOs/Desktop/NurseryDto.cs](ReactApp.Server/DTOs/Desktop/NurseryDto.cs)

**NurseryDto クラスに追加**:
```csharp
[StringLength(100, ErrorMessage = "園長名は100文字以内で入力してください")]
public string? PrincipalName { get; set; }

public DateTime? EstablishedDate { get; set; }
```

**UpdateNurseryRequestDto クラスに追加**:
```csharp
[StringLength(100, ErrorMessage = "園長名は100文字以内で入力してください")]
public string? PrincipalName { get; set; }

public DateTime? EstablishedDate { get; set; }
```

#### 5. バックエンドサービス層の修正

**ファイル**: [ReactApp.Server/Services/DesktopMasterService.cs](ReactApp.Server/Services/DesktopMasterService.cs)

**GetNurseryAsync() メソッドの修正** (44-59行目):
```csharp
return new NurseryDto
{
    Id = nursery.Id,
    Name = nursery.Name,
    Address = nursery.Address,
    PhoneNumber = nursery.PhoneNumber,
    Email = nursery.Email,
    PrincipalName = nursery.PrincipalName,        // 追加
    EstablishedDate = nursery.EstablishedDate,    // 追加
    CurrentAcademicYear = nursery.CurrentAcademicYear,
    LoginId = nursery.LoginId,
    LastLoginAt = nursery.LastLoginAt,
    IsLocked = nursery.IsLocked,
    LockedUntil = nursery.LockedUntil,
    LoginAttempts = nursery.LoginAttempts
};
```

**UpdateNurseryAsync() メソッドの修正** (207-216行目):
```csharp
nursery.Name = request.Name;
nursery.Address = request.Address ?? string.Empty;
nursery.PhoneNumber = request.PhoneNumber ?? string.Empty;
nursery.Email = request.Email ?? string.Empty;
nursery.PrincipalName = request.PrincipalName ?? string.Empty;  // 追加
if (request.EstablishedDate.HasValue)                            // 追加
{
    nursery.EstablishedDate = request.EstablishedDate.Value;
}
nursery.UpdatedAt = DateTime.UtcNow;
```

**返却値にも追加** (219-234行目):
```csharp
return new NurseryDto
{
    Id = nursery.Id,
    Name = nursery.Name,
    Address = nursery.Address,
    PhoneNumber = nursery.PhoneNumber,
    Email = nursery.Email,
    PrincipalName = nursery.PrincipalName,        // 追加
    EstablishedDate = nursery.EstablishedDate,    // 追加
    CurrentAcademicYear = nursery.CurrentAcademicYear,
    LoginId = nursery.LoginId,
    LastLoginAt = nursery.LastLoginAt,
    IsLocked = nursery.IsLocked,
    LockedUntil = nursery.LockedUntil,
    LoginAttempts = nursery.LoginAttempts
};
```

#### 6. 型変換の問題と解決

**発生した問題**:
```
error CS0266: 型 'System.DateTime?' を 'System.DateTime' に暗黙的に変換できません
```

**原因**:
- DTOの `EstablishedDate` は `DateTime?`（nullable）
- Nurseryモデルの `EstablishedDate` は `DateTime`（not null）
- nullable から not null への暗黙的な変換は不可

**解決方法**:
```csharp
// ❌ 修正前（コンパイルエラー）
nursery.EstablishedDate = request.EstablishedDate;

// ✅ 修正後（nullable チェック）
if (request.EstablishedDate.HasValue)
{
    nursery.EstablishedDate = request.EstablishedDate.Value;
}
```

### 修正されたファイル一覧

#### フロントエンド
1. `reactapp.client/src/desktop/pages/NurseryInfoPage.tsx` - UI要素の削除、デバッグログ追加
2. `reactapp.client/src/desktop/types/master.ts` - 型定義の整理（不要フィールド削除、必要フィールド追加）

#### バックエンド
3. `ReactApp.Server/DTOs/Desktop/NurseryDto.cs` - PrincipalName, EstablishedDate追加
4. `ReactApp.Server/Services/DesktopMasterService.cs` - マッピング処理追加

### データベーススキーマ（確認済み）

**Nurseries テーブルの実際の構造**:
```sql
CREATE TABLE [dbo].[Nurseries] (
  [Id] int NOT NULL PRIMARY KEY,
  [Name] nvarchar(100) NOT NULL,
  [LoginID] nvarchar(10),
  [Password] nvarchar(255),
  [Address] nvarchar(500) NOT NULL,
  [PhoneNumber] nvarchar(20) NOT NULL,
  [Email] nvarchar(255) NOT NULL,
  [PrincipalName] nvarchar(100) NOT NULL,      -- ✅ 存在
  [EstablishedDate] datetime2 NOT NULL,         -- ✅ 存在
  [LogoUrl] nvarchar(500),
  [ApplicationKey] nvarchar(50),
  [LastLoginAt] datetime2,
  [LoginAttempts] int DEFAULT 0 NOT NULL,
  [IsLocked] bit DEFAULT 0 NOT NULL,
  [LockedUntil] datetime2,
  [CurrentAcademicYear] int DEFAULT datepart(year,getdate()) NOT NULL,
  [CreatedAt] datetime2 DEFAULT getutcdate() NOT NULL,
  [UpdatedAt] datetime2
);
```

### 動作確認状況

**確認済み**:
- ✅ フロントエンドのコンパイル成功（TypeScript型エラーなし）
- ✅ バックエンドのコンパイルエラー修正完了
- ✅ 不要フィールド（capacity, operatingHours, website, description）の削除完了
- ✅ 必要フィールド（principalName, establishedDate）のマッピング追加完了

**未確認（サーバー再起動が必要）**:
- ⏳ APIレスポンスに principalName と establishedDate が含まれること
- ⏳ 画面で園長名と設立日が正しく表示されること
- ⏳ 園長名と設立日の編集・保存が正常に動作すること

### 残課題

1. **サーバー再起動**
   - バックエンドのコンパイルエラーが修正されたため、サーバーを再起動して新しいコードを反映する必要がある

2. **データの確認と追加**
   - データベースに PrincipalName と EstablishedDate の実際のデータが入っているか確認
   - データがない場合は以下のSQLで追加:
   ```sql
   UPDATE Nurseries
   SET PrincipalName = N'田中 花子',
       EstablishedDate = '2015-04-01'
   WHERE Id = 1;
   ```

3. **動作確認**
   - サーバー再起動後、https://localhost:5182/desktop/nurseries にアクセス
   - ブラウザコンソールで以下を確認:
     ```
     === Nursery Data Received === { ..., principalName: "...", establishedDate: "..." }
     ```
   - 園長名と設立日が画面に表示されることを確認
   - 編集・保存が正常に動作することを確認

### テスト用SQLスクリプト

**作成したファイル**:
1. `check_nursery_schema.sql` - Nurseriesテーブルのスキーマ確認用
2. `check_nursery_fields.sql` - 園長名・設立日の現在値確認用
3. `update_nursery_test_data.sql` - テストデータ追加用

### 技術的な課題と解決

**課題1**: コンソールログで `principalName: undefined` と表示
- **原因**: バックエンドのコンパイルエラーのため、古いバージョンのサーバーが実行されていた
- **解決**: 型変換エラーを修正し、サーバー再起動が必要

**課題2**: DateTime? から DateTime への暗黙的変換エラー
- **原因**: DTOのnullable型とモデルのnot null型の不一致
- **解決**: HasValue チェックを使用した明示的な変換

### 次回セッションでの確認事項

1. サーバーを再起動して新しいコードを適用
2. APIレスポンスに principalName と establishedDate が含まれることを確認
3. 画面での表示・編集・保存が正常に動作することを確認
4. 必要に応じてテストデータを追加

### 関連ドキュメント

- [Nurseryモデル](ReactApp.Server/Models/Nursery.cs)
- [NurseryDto](ReactApp.Server/DTOs/Desktop/NurseryDto.cs)
- [DesktopMasterService](ReactApp.Server/Services/DesktopMasterService.cs)
- [NurseryInfoPage](reactapp.client/src/desktop/pages/NurseryInfoPage.tsx)
