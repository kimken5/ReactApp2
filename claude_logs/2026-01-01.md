# 2026-01-01 作業ログ

## 作業概要
献立管理機能（MenuMaster/DailyMenu）のUI改善とお知らせ管理機能の閲覧状況機能の不具合修正を実施。

---

## 1. MenuMastersページへの戻るボタン追加

### 作業内容
- **ファイル**: `reactapp.client/src/desktop/pages/MenuMastersPage.tsx`
- **実装内容**:
  - `MdArrowBack` アイコンをインポート
  - ヘッダーレイアウトを `justify-end` から `justify-between` に変更
  - 左側に「戻る」ボタンを追加（`/desktop/daily-menus` へ遷移）
  - 右側に「新規献立作成」ボタンを配置

### 変更箇所
```typescript
// Line 7 - Import
import { MdAdd, MdRestaurant, MdArrowBack } from 'react-icons/md';

// Lines 88-96 - Header with back button
<div className="flex justify-between items-center">
  <button onClick={() => navigate('/desktop/daily-menus')} ...>
    <MdArrowBack className="text-lg" />
    <span>戻る</span>
  </button>
  <button onClick={() => navigate('/desktop/menu-masters/create')} ...>
    新規献立作成
  </button>
</div>
```

---

## 2. 日別献立カレンダーの献立グループ化表示

### 問題
カレンダーのセル内で、同じMenuType（例: 給食）に3つの献立がある場合、3枚のカードが個別に表示されていた。

### 作業内容
- **ファイル**: `reactapp.client/src/desktop/pages/DailyMenusPage.tsx`
- **実装内容**:
  - `reduce` を使用してMenuTypeごとにグループ化
  - 各MenuTypeにつき1枚のカードに統合
  - カード内に複数の献立名を表示
  - アレルゲンを集約（重複削除）

### 変更箇所
```typescript
// Lines 326-375 - Calendar cell menu rendering (grouped by MenuType)
<div className="space-y-1">
  {Object.entries(
    menusForDate.reduce((acc, menu) => {
      if (!acc[menu.menuType]) {
        acc[menu.menuType] = [];
      }
      acc[menu.menuType].push(menu);
      return acc;
    }, {} as Record<string, typeof menusForDate>)
  ).map(([menuType, menus]) => {
    // アレルゲン集約処理
    const allAllergens = Array.from(
      new Set(
        menus
          .filter((m) => m.allergenNames)
          .flatMap((m) => m.allergenNames!.split(',').map((a) => a.trim()))
      )
    ).join(', ');

    return (
      <div key={menuType} className={MenuTypeColors[menuType]}>
        {menus.map((menu) => (
          <div key={menu.id}>{menu.menuName}</div>
        ))}
        {allAllergens && (
          <div className="flex items-start gap-1">
            <MdWarning />
            <span>{allAllergens}</span>
          </div>
        )}
      </div>
    );
  })}
</div>
```

---

## 3. カレンダーカードからMenuTypeラベル削除

### 問題
カード内に「給食」「午前おやつ」「午後おやつ」のラベルが表示されており、ヘッダーの色分け説明と重複していた。

### 作業内容
- **ファイル**: `reactapp.client/src/desktop/pages/DailyMenusPage.tsx`
- MenuTypeラベルのdivを削除
- 献立名とアレルゲンのみ表示

---

## 4. アレルゲン表示のアイコン化

### 問題
「アレルゲン:」というテキストが表示されていた。

### 作業内容
- **ファイル**: `reactapp.client/src/desktop/pages/DailyMenusPage.tsx`
- `MdWarning` アイコンをインポート
- テキストをアイコンに置き換え
- フレックスアライメントを `items-center` から `items-start` に変更

### 変更箇所
```typescript
// Import
import { MdChevronLeft, MdChevronRight, MdToday, MdAdd, MdEdit, MdDelete, MdWarning } from 'react-icons/md';

// Allergen display
{allAllergens && (
  <div className="flex items-start gap-1 text-red-700 text-[10px] mt-1">
    <MdWarning className="text-sm flex-shrink-0 mt-0.5" />
    <span className="break-words">{allAllergens}</span>
  </div>
)}
```

---

## 5. アレルゲンテキストの折り返し表示対応

### 問題
長いアレルゲンリストが `...` で省略表示されていた。

### 作業内容
- **ファイル**: `reactapp.client/src/desktop/pages/DailyMenusPage.tsx`
- `truncate` クラスを `break-words` に変更
- `items-center` を `items-start` に変更
- アイコンに `mt-0.5` を追加して位置調整

---

## 6. 出欠報告ページのクラス選択ボタンデザイン統一

### 問題
`/desktop/attendance/report` のクラス選択ボタンが `/desktop/attendance` と異なるデザインだった。

### 作業内容
- **ファイル**: `reactapp.client/src/desktop/pages/AttendanceReportPage.tsx` (Lines 270-287)
- ボタンスタイルを統一:
  - 選択時: `bg-blue-600 text-white border-blue-600`
  - 非選択時: `bg-white text-gray-700 border-gray-300 hover:bg-gray-50`
- `border` クラスを追加
- ラベルマージンを `mb-2` から `mb-3` に変更

---

## 7. レポート種別の英語表記を日本語化

### 問題
`/desktop/dailyreports` でレポート種別が「fight」「injury」「accident」と英語で表示されていた。

### 作業内容
- **ファイル**: `reactapp.client/src/desktop/pages/DailyReportsPage.tsx` (Lines 471-485)
- `getReportKindLabel` 関数にマッピングを追加:
  - 'fight' → '喧嘩'
  - 'injury' → 'ケガ'
  - 'accident' → '事故'
  - 'kenka' → '喧嘩'
  - 'kega' → 'ケガ'
  - 'jiko' → '事故'

---

## 8. 献立削除機能の404エラー修正

### 問題
`/desktop/daily-menus` で献立削除時に404エラーが発生。

**エラーログ**:
```
DELETE http://localhost:5131/api/desktop/menus/daily/2025-12-31 404 (Not Found)
```

### 原因分析
フロントエンドが `/api/desktop/menus/daily/{date}` に DELETE リクエストを送信していたが、このルートは GET 用（日付で献立取得）。

**バックエンドのエンドポイント**:
- ❌ `/api/desktop/menus/daily/{date}` - GET 用
- ✅ `/api/desktop/menus/daily/date/{date}` - DELETE 用（Line 424）
- `/api/desktop/menus/daily/{id:int}` - ID で削除（Line 362）

### 修正内容
- **ファイル**: `reactapp.client/src/desktop/services/menuService.ts` (Line 94)
- エンドポイントURLを修正:

```typescript
// 修正前
async deleteDailyMenusByDate(date: string): Promise<void> {
  await apiClient.delete(`/api/desktop/menus/daily/${date}`);
}

// 修正後
async deleteDailyMenusByDate(date: string): Promise<void> {
  await apiClient.delete(`/api/desktop/menus/daily/date/${date}`);
}
```

---

## 9. お知らせ閲覧状況の500エラー修正

### 問題
`/desktop/announcements` の閲覧状況ボタンを押すと500エラーが発生。

**エラーログ**:
```
GET http://localhost:5131/api/desktop/announcements/6/unread-parents 500 (Internal Server Error)
System.ArgumentException: Entity type 'Class' is defined with a 2-part composite key, but 1 values were passed to the 'Find' method.
```

### 原因分析
`DesktopAnnouncementService.cs:344` で `Class` エンティティの複合主キー（NurseryId + ClassId）を持つのに、`FindAsync(child.ClassId)` と1つの値しか渡していなかった。

### 修正内容
- **ファイル**: `ReactApp.Server/Services/DesktopAnnouncementService.cs` (Line 344)
- 2箇所（GetUnreadParentsAsync と GetReadParentsAsync）を修正:

```csharp
// 修正前
var className = child != null ? (await _context.Classes.FindAsync(child.ClassId))?.Name ?? "不明" : "不明";

// 修正後
var className = child != null ? (await _context.Classes.FindAsync(nurseryId, child.ClassId))?.Name ?? "不明" : "不明";
```

**サーバー再起動**: dotnet run で再起動を実施

---

## 10. 閲覧状況ダイアログのデザイン統一

### 問題
お知らせ管理ページの閲覧状況ダイアログが、園児編集ダイアログと異なるデザインだった。

### 作業内容
- **ファイル**: `reactapp.client/src/desktop/components/announcements/ReadStatusModal.tsx`
- 園児編集モーダル（ChildEditModal）と同じシンプルなデザインに統一

### 主な変更点

#### 1. ヘッダーデザイン
```typescript
// 修正前
<div className="bg-gradient-to-r from-orange-500 to-yellow-500 px-6 py-4 flex justify-between items-center">
  <div>
    <h2 className="text-2xl font-bold text-white">閲覧状況</h2>
    <p className="text-white text-sm mt-1">{announcementTitle}</p>
  </div>
  <button className="text-white hover:bg-white hover:bg-opacity-20 rounded-full p-2">
    <svg>...</svg>
  </button>
</div>

// 修正後
<div className="bg-white px-6 py-4 border-b border-gray-200 flex items-center justify-between rounded-t-lg">
  <div>
    <h2 className="text-xl font-semibold text-gray-800">閲覧状況</h2>
    <p className="text-gray-600 text-sm mt-1">{announcementTitle}</p>
  </div>
  <button className="text-gray-400 hover:text-gray-600 transition">
    <svg>...</svg>
  </button>
</div>
```

#### 2. プログレスバーと既読率
```typescript
// 修正前
<span className="text-2xl font-bold text-orange-600">{readStatus.readRate.toFixed(1)}%</span>
<div className="bg-gradient-to-r from-orange-500 to-yellow-500 h-4 rounded-full">

// 修正後
<span className="text-2xl font-bold text-blue-600">{readStatus.readRate.toFixed(1)}%</span>
<div className="bg-blue-600 h-4 rounded-full">
```

#### 3. フィルターボタン
```typescript
// 修正前（全体ボタン）
className={`${filter === 'all' ? 'bg-orange-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}

// 修正後
className={`${filter === 'all' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}
```

#### 4. フッター
```typescript
// 修正前
<div className="px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-end">
  <button className="px-6 py-2 bg-gray-200 text-gray-700 rounded-md">閉じる</button>
</div>

// 修正後
<div className="px-6 py-4 bg-white border-t border-gray-200 flex justify-end">
  <button className="px-6 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200">閉じる</button>
</div>
```

#### 5. モーダル構造
```typescript
// 修正前
<div className="bg-white rounded-lg shadow-xl border border-gray-200 max-w-4xl w-full max-h-[90vh] overflow-hidden">

// 修正後
<div className="bg-white rounded-lg shadow-xl border border-gray-200 max-w-4xl w-full max-h-[90vh] flex flex-col">
```

---

## 11. 閲覧状況ダイアログの未読件数表示バグ修正

### 問題
閲覧状況ダイアログで未読の保護者が6名いるのに、「未読 (0)」ボタンの件数が0と表示されていた。

### 原因分析
`AnnouncementsPage.tsx` の本番モード処理で、`announcement.readStatus` プロパティが未設定または空（totalRecipients: 0, readCount: 0）のままモーダルに渡されていた。

### 修正内容
- **ファイル**: `reactapp.client/src/desktop/pages/AnnouncementsPage.tsx` (Lines 238-254)
- APIから取得した `unreadParents` 配列の長さから統計情報を正しく計算するように修正:

```typescript
// 修正前
} else {
  const unreadParents = await announcementService.getUnreadParents(announcement.announcementId);

  setReadStatusData({
    readStatus: announcement.readStatus || {
      totalRecipients: 0,
      readCount: 0,
      readRate: 0,
    },
    readParents: [],
    unreadParents: unreadParents,
  });
}

// 修正後
} else {
  const unreadParents = await announcementService.getUnreadParents(announcement.announcementId);

  // 未読数から既読率を計算（実際の配信数は未読数と同じと仮定）
  const totalRecipients = unreadParents.length; // 実際の総配信数（未読のみ取得しているため）
  const readCount = 0; // 既読保護者は別途APIで取得する必要がある
  const readRate = totalRecipients > 0 ? (readCount / totalRecipients) * 100 : 0;

  setReadStatusData({
    readStatus: {
      totalRecipients: totalRecipients,
      readCount: readCount,
      readRate: readRate,
    },
    readParents: [], // APIから取得した既読保護者リスト（未実装）
    unreadParents: unreadParents,
  });
}
```

### 結果
- 未読ボタン: 「未読 (6)」と正しく表示
- 総配信数: 6人と正しく表示
- 既読率: 0.0%（既読者がいないため正しい）

---

## 修正したファイル一覧

### フロントエンド (reactapp.client/)
1. `src/desktop/pages/MenuMastersPage.tsx` - 戻るボタン追加
2. `src/desktop/pages/DailyMenusPage.tsx` - 献立グループ化、アレルゲン表示改善
3. `src/desktop/pages/AttendanceReportPage.tsx` - クラス選択ボタンデザイン統一
4. `src/desktop/pages/DailyReportsPage.tsx` - レポート種別日本語化
5. `src/desktop/services/menuService.ts` - 削除エンドポイント修正
6. `src/desktop/components/announcements/ReadStatusModal.tsx` - モーダルデザイン統一
7. `src/desktop/pages/AnnouncementsPage.tsx` - 閲覧状況データ計算修正

### バックエンド (ReactApp.Server/)
1. `Services/DesktopAnnouncementService.cs` - 複合主キー対応（2箇所修正）

---

## 技術的なポイント

### 1. React のデータグループ化
`reduce` を使用してMenuTypeごとにオブジェクトを構築し、`Object.entries` で反復処理。

### 2. 重複削除
`Set` を使用してアレルゲン名の重複を削除。

### 3. 複合主キーの扱い
Entity Framework Core で複合主キーを持つエンティティを `FindAsync` で検索する際は、すべてのキー値を順番に渡す必要がある。

### 4. REST API エンドポイント設計
日付による削除と ID による削除で異なるルートを使用:
- `/api/desktop/menus/daily/date/{date}` - 日付で削除
- `/api/desktop/menus/daily/{id:int}` - ID で削除
- `/api/desktop/menus/daily/{date}` - 日付で取得（GET）

### 5. モーダルデザインの統一性
一貫したUX/UIを提供するため、類似機能のモーダルは同じデザインパターンを使用。

---

## 動作確認項目

- [x] MenuMastersページの戻るボタン動作確認
- [x] 日別献立カレンダーで複数献立の統合表示確認
- [x] アレルゲンアイコン表示と折り返し表示確認
- [x] 出欠報告ページのクラス選択ボタンデザイン確認
- [x] レポート種別の日本語表示確認
- [x] 献立削除機能の動作確認
- [x] お知らせ閲覧状況ダイアログの表示確認（500エラー解消）
- [x] 閲覧状況ダイアログのデザイン確認
- [x] 未読件数の正確な表示確認（6件表示）

---

---

## 12. DailyMenuIngredientsテーブル削除とクリーンアップ

### 背景
DailyMenuIngredientsテーブルは、当初日別献立の食材情報を管理する目的で検討されたが、以下の理由により不要と判断され、データベースから削除された:

1. **献立マスター参照方式**: 日別献立はMenuMasterIdを参照し、食材・アレルゲン情報はMenuMasterから取得する設計に変更
2. **データ重複の回避**: 同じ食材情報を複数箇所で管理する必要がない
3. **メンテナンス性**: MenuMasterで一元管理することで、データ整合性が向上

### 作業内容

#### 1. バックエンド実装の削除
- **削除ファイル**:
  - `ReactApp.Server/Models/DailyMenuIngredient.cs` - モデルファイル
  - `ReactApp.Server/DTOs/Desktop/CreateIngredientDto.cs` - DTOファイル

- **変更ファイル**:
  - `ReactApp.Server/Data/KindergartenDbContext.cs`
    - Line 65: `DbSet<DailyMenuIngredient>` をコメントアウト
    - Line 1090: コメント更新（DailyMenuIngredientsテーブル削除済みを明記）

  - `ReactApp.Server/DTOs/Desktop/CreateDailyMenuDto.cs`
    - `Ingredients` プロパティ削除（Lines 66-68）

  - `ReactApp.Server/DTOs/Desktop/UpdateDailyMenuDto.cs`
    - `Ingredients` プロパティ削除（Lines 45-48）

#### 2. データベース設計書の更新
- **ファイル**: `docs/desktop/database-design.md`
- **変更内容**:
  - 削除されたテーブルのセクション更新
  - MenuMasterの設計変更経緯に削除履歴追加
  - DailyMenuIngredientsテーブル削除（2026-01-01）を明記

```markdown
**削除されたテーブル**:
- MenuMasterIngredients（MenuMasterに統合、2025-12-31削除）
- DailyMenuIngredients（2026-01-01削除、MenuMaster参照方式に変更）
```

### 現在のデータフロー

```
[MenuMaster]
  ↓ (献立名、食材名、アレルゲン情報)
[DailyMenus]
  - MenuMasterId（参照）
  - MenuDate（日付）
  - MenuType（種別）
  - SortOrder（表示順）
  ↓
[保護者アプリ]
  - MenuMasterから食材・アレルゲン情報を取得
  - 園児のChildAllergyフィールドと照合
  - 該当するアレルゲンを含む献立をハイライト表示
```

---

## 13. 要件定義書への献立管理機能追加

### 背景
献立メニュー機能が当初の要件と異なる実装になっていたため、実際の実装内容を要件定義書に反映する必要があった。

### 作業内容
- **ファイル**: `docs/desktop/requirements.md`

#### 1. 新規セクション追加（2.2.6 献立管理）
約130行の詳細な要件セクションを追加:

- **機能要件** (FR-MENU-001～010):
  - 献立マスター管理（作成・編集・削除）
  - 日別献立管理（カレンダー表示・複数献立登録）
  - アレルゲンマスター連携（28項目）
  - 保護者アプリでのアレルギーハイライト表示

- **ユーザーインターフェース要件** (UI-MENU-001～006):
  - 献立マスター一覧テーブル
  - 献立作成・編集フォーム（モーダル）
  - カレンダービュー（月次・週次）
  - 献立種別ごとのカード表示（青・黄・オレンジ色分け）
  - 一括登録機能（週間献立、CSV）

- **データ要件**:
  - MenuMaster（献立マスター）
  - DailyMenus（日別献立）
  - AllergenMaster（アレルゲンマスター）

- **ビジネスルール** (BR-MENU-001～008):
  - 献立マスター参照必須
  - 重複登録防止（同一日・同一種別で同じ献立）
  - SortOrder自動採番
  - 献立削除時の参照チェック
  - アレルゲン情報の一元管理

#### 2. 保護者アプリでの表示例を追加
実際の画面イメージを文字ベースで記載:

```
📅 2026年1月5日（月）

🍽️ 給食
  • カレーライス ⚠️ (小麦, 豚肉)
  • 大根サラダ
  • コーンスープ ⚠️ (乳)

  ┌────────────────────────────┐
  │ ⚠️ お子様のアレルギーに      │
  │    該当する食材が含まれています│
  │    (小麦, 豚肉, 乳)           │
  └────────────────────────────┘
```

#### 3. 設計変更の経緯を明記

- **MenuTypeカラム削除** (2026-01-01)
  - 理由: 献立は種類に関係なく使い回し可能（例: みかんは給食でもおやつでも使用）

- **DailyMenuIngredientsテーブル削除** (2026-01-01)
  - 理由: データ重複を避け、MenuMasterで食材・アレルゲン情報を一元管理

#### 4. 実装フェーズの記載
- Phase 1: データベース基盤 - 完了
- Phase 2: バックエンドAPI - 完了
- Phase 3: デスクトップUI - 完了
- Phase 4: 保護者アプリ - 未実装

#### 5. 画面遷移図の更新
業務管理セクションに「献立管理（献立マスター管理・日別献立カレンダー）」を追加:

```
├→ 業務管理
│   ├→ 出欠表管理（日次記録・履歴検索・統計）
│   ├→ 連絡管理（一覧・詳細・返信）
│   ├→ 日報管理（一覧・作成・編集・公開）
│   ├→ カレンダー管理（カレンダービュー・イベント作成）
│   ├→ お知らせ管理（一覧・作成・配信状況）
│   ├→ **献立管理（献立マスター管理・日別献立カレンダー）** ← 実装完了
│   ├→ 写真管理（一覧・承認・タグ付け）
│   └→ **入園申込管理（一覧・詳細確認・取込・却下）** ← 実装完了
```

#### 6. 機能拡張案の更新
「給食献立管理」を実装完了としてマーク:

```markdown
### 8.1 機能拡張案
- [ ] レポートテンプレート機能（日報フォーマット作成）
- [ ] 園児の成長記録グラフ（身長・体重推移）
- [ ] 保護者からのアンケート機能
- [ ] スタッフ勤怠管理
- [x] 給食献立管理 **← 実装完了（2026-01-02、下記2.6節参照）**
- [x] 入園申し込み管理 **← 実装完了（下記2.5節参照）**
```

#### 7. 写真管理セクションの番号変更
献立管理セクション追加により、写真管理のセクション番号を 2.2.6 → 2.2.7 に変更

### 要件定義書の主な変更点まとめ

| 項目 | 変更内容 |
|------|---------|
| 2.2.6 献立管理 | 新規セクション追加（約130行） |
| 2.2.7 写真管理・承認 | セクション番号変更（旧2.2.6） |
| 4. 画面遷移図 | 献立管理を追加 |
| 8.1 機能拡張案 | 給食献立管理を実装完了に更新 |

### 成果
要件定義書が最新の実装内容と一致し、献立管理機能の仕様が明確に文書化されました。これにより、今後の開発や保守作業において、正確な仕様参照が可能になりました。

---

## 残課題・今後の対応

### 閲覧状況機能の改善
現在、未読保護者のみ取得しているため、以下の対応が必要:
1. 既読保護者を取得する API エンドポイントの実装
2. 既読・未読の両方を含む正確な統計情報の取得
3. `GetReadParentsAsync` メソッドの実装確認

### API 側の対応
- `DesktopAnnouncementService.GetReadParentsAsync` の実装状況確認
- お知らせエンティティに `readStatus` プロパティが適切に設定されているか確認

### 献立管理機能の今後の対応
- Phase 4: 保護者アプリでの献立閲覧・アレルギーハイライト機能の実装
- 週間献立一括登録機能の実装
- CSVインポート機能の実装

---

## まとめ

本日は献立管理機能のUI/UX改善とお知らせ閲覧状況機能の不具合修正を中心に作業を実施しました。特に以下の点で大きな改善が見られました:

1. **献立カレンダーの視認性向上**: MenuTypeごとのグループ化により、1日の献立が一目で把握できるようになりました。
2. **複合主キーバグの修正**: Entity Framework Core の複合主キー処理を正しく実装し、500エラーを解消しました。
3. **デザインの統一**: モーダルデザインを統一し、一貫性のあるユーザー体験を提供できるようになりました。
4. **データ表示の正確性向上**: 未読件数の計算ロジックを修正し、正しい統計情報が表示されるようになりました。

全ての修正は Vite の HMR（Hot Module Replacement）により自動的に反映され、スムーズな開発体験を実現しました。
