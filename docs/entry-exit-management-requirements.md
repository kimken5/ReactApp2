# 保護者入退管理機能 要件定義書

## ドキュメント情報
- **作成日**: 2026-01-14
- **バージョン**: 1.0
- **ステータス**: 初版 - レビュー待ち

---

## 目次
1. [概要](#1-概要)
2. [ビジネス要件](#2-ビジネス要件)
3. [機能要件](#3-機能要件)
4. [システム構成](#4-システム構成)
5. [データモデル](#5-データモデル)
6. [ユーザーインターフェース要件](#6-ユーザーインターフェース要件)
7. [セキュリティ要件](#7-セキュリティ要件)
8. [非機能要件](#8-非機能要件)
9. [制約事項](#9-制約事項)
10. [今後の拡張性](#10-今後の拡張性)

---

## 1. 概要

### 1.1 目的
保護者の送り迎え時の入退園を記録・管理することで、以下を実現する：
- 保育園のセキュリティ向上（誰が、いつ入退園したかの記録）
- 送り迎え時刻の可視化（出欠管理との連携）
- 園児の引き渡し記録の正確化
- トラブル発生時の証跡確保

### 1.2 適用範囲
- **対象ユーザー**: 保育園に通う園児の保護者（Parent）
- **対象デバイス**:
  - 保護者: スマートフォン（保護者アプリ）
  - 保育園: タブレット + USBバーコードスキャナ
- **対象施設**: システムに登録された全保育園（Nursery）

### 1.3 用語定義
| 用語 | 定義 |
|------|------|
| 入退管理 | 保護者が保育園に入園（入）・退園（出）した記録の管理 |
| 保護者IDバーコード | 保護者ID（Parent.Id）をCode128形式でエンコードしたバーコード |
| 入退登録画面 | タブレットで表示される、バーコードスキャン用の専用画面 |
| 入退登録端末 | タブレット + USBバーコードスキャナの組み合わせ |
| 入退ログ | 保護者の入退園時刻を記録したデータ（EntryExitLog） |

---

## 2. ビジネス要件

### 2.1 ビジネス目標
- **BG-001**: 保護者の送り迎え記録を自動化し、手書き台帳を廃止する
- **BG-002**: 園児の引き渡し時刻を正確に記録し、トラブル防止に役立てる
- **BG-003**: 出欠管理と連携し、実際の送り迎え時刻を可視化する
- **BG-004**: セキュリティ向上のため、園内への入退園履歴を保持する

### 2.2 ビジネス課題
- **BC-001**: 現状の手書き台帳では、記入漏れや誤記が発生しやすい
- **BC-002**: 送り迎え時刻の記録が不正確で、後から確認できない
- **BC-003**: 保護者が園内にいるかどうかの把握が困難
- **BC-004**: トラブル発生時の証跡が不十分

### 2.3 成功指標
- **KPI-001**: 導入後3ヶ月で保護者の90%以上がバーコード登録を利用
- **KPI-002**: 記録漏れ率を5%以下に抑制
- **KPI-003**: スキャンから記録完了までの処理時間を2秒以内に実現
- **KPI-004**: 保育園スタッフの入退記録確認作業時間を50%削減

---

## 3. 機能要件

### 3.1 保護者アプリ - 保護者IDバーコード表示機能

#### 3.1.1 機能要件
- **FR-PA-001**: 保護者アプリに「保護者IDバーコード」表示画面を追加する
- **FR-PA-002**: 保護者ID（Parent.Id）をCode128形式でバーコード化して表示する
- **FR-PA-003**: バーコードは画面に大きく、スキャンしやすいサイズで表示する
- **FR-PA-004**: バーコード下部に保護者ID（数値）をテキストで表示する
- **FR-PA-005**: バーコード上部に保護者名（Parent.Name）を表示する
- **FR-PA-006**: 画面の明るさを自動で最大にする（スキャン精度向上）
- **FR-PA-007**: オフライン時でもバーコード表示可能とする（ローカルストレージから読み込み）

#### 3.1.2 ユーザーインターフェース要件
- **UI-PA-001**: ナビゲーションメニューに「入退管理バーコード」アイテムを追加
- **UI-PA-002**: バーコード表示画面はシンプルで視認性の高いデザイン
- **UI-PA-003**: バーコードサイズ: 横幅80%、高さ150px程度
- **UI-PA-004**: 背景色: 白（#FFFFFF）、前景色: 黒（#000000）
- **UI-PA-005**: 使い方の説明文を画面下部に表示（「保育園のスキャナーにかざしてください」）

#### 3.1.3 技術要件
- **TR-PA-001**: バーコード生成にはJavaScriptライブラリ（JsBarcode等）を使用
- **TR-PA-002**: バーコードフォーマット: Code128
- **TR-PA-003**: バーコードデータ: 保護者ID（数値のみ、0パディングなし）
- **TR-PA-004**: localStorage に保護者IDを保存（オフライン対応）

---

### 3.2 入退登録画面（タブレット専用画面）

#### 3.2.1 機能要件
- **FR-ER-001**: タブレットブラウザで表示する入退登録専用画面を新設する
- **FR-ER-002**: 「入」「出」のトグルボタンを画面上部に配置する
- **FR-ER-003**: USBバーコードスキャナからの入力を受け付ける
- **FR-ER-004**: スキャンされた保護者IDと、選択中の「入/出」状態、保育園IDでログを記録する
- **FR-ER-005**: スキャン後、視覚フィードバックを提供する（画面フラッシュ、メッセージ表示）
- **FR-ER-006**: スキャン履歴を画面下部にリアルタイム表示する（最新10件）
- **FR-ER-007**: ネットワークエラー時は一時的にローカルに保存し、復旧後に送信する

#### 3.2.2 ユーザーインターフェース要件
- **UI-ER-001**: 画面レイアウト: タブレット横向き（Landscape）を想定
- **UI-ER-002**: 「入」「出」ボタン: 大きく、視認性の高いトグルスイッチ
  - 「入」選択時: 緑色背景（bg-green-500）
  - 「出」選択時: オレンジ色背景（bg-orange-500）
- **UI-ER-003**: 現在時刻をリアルタイム表示（例: 2026-01-14 09:15:32）
- **UI-ER-004**: スキャン待機状態の表示（「バーコードをスキャンしてください」）
- **UI-ER-005**: スキャン成功時のフィードバック:
  - 画面全体を一瞬緑色にフラッシュ（200ms）
  - メッセージを大きく表示（3秒間）:
    * 「入」の場合: 「〇〇さん。おはようございます。」
    * 「出」の場合: 「〇〇さん。お疲れ様でした。」
  - ※ 音声フィードバックは不要
- **UI-ER-006**: スキャン失敗時のフィードバック:
  - 画面全体を一瞬赤色にフラッシュ（200ms）
  - エラーメッセージを表示（「保護者が見つかりません」等）
  - ※ 音声フィードバックは不要
- **UI-ER-007**: スキャン履歴テーブル:
  - 列: 時刻、保護者名、入/出、ステータス
  - 最新10件を降順表示
  - 自動スクロール（最新が常に上部）

#### 3.2.3 バーコードスキャナ要件
- **BR-ER-001**: USBバーコードスキャナは「キーボードエミュレーションモード」で動作
- **BR-ER-002**: スキャンされたデータは改行コード（Enter）付きでinput要素に入力される
- **BR-ER-003**: input要素にフォーカスを常に維持する（blur時に自動再フォーカス）
- **BR-ER-004**: スキャンデータの形式検証（数値のみ、1～10桁）

#### 3.2.4 技術要件
- **TR-ER-001**: React + TypeScript で実装
- **TR-ER-002**: 専用ルート: `/entry-exit-registration`
- **TR-ER-003**: レスポンシブデザイン不要（タブレット専用）
- **TR-ER-004**: オフライン時のデータ蓄積: IndexedDB または localStorage
- **TR-ER-005**: バーコード入力を受け取る非表示input要素を配置
- **TR-ER-006**: ハートビート機能: 30秒ごとにサーバーにping送信（セッション維持）

---

### 3.3 入退登録画面用ログイン機能

#### 3.3.1 機能要件
- **FR-EL-001**: 入退登録画面専用のログイン画面を新設する
- **FR-EL-002**: ログイン方法: 保育園コード（文字列）+ パスワード
- **FR-EL-003**: ログイン成功後、入退登録画面にリダイレクトする
- **FR-EL-004**: セッションは無期限（ハートビートによる維持）
- **FR-EL-005**: ログアウト機能を提供する（画面右上に配置）
- **FR-EL-006**: ハートビート機能により、画面表示中は常にセッションを維持する

#### 3.3.2 認証要件
- **AR-EL-001**: 保育園コード（Nursery.Code）とパスワードでログインする
- **AR-EL-002**: パスワードは保育園ごとに設定可能とする（管理画面で設定）
- **AR-EL-003**: ログイン失敗時は5回まで試行可能、6回目以降は10分間ロックアウト
- **AR-EL-004**: JWT トークンを使用してセッション管理を行う
- **AR-EL-005**: トークンは localStorage に保存する

#### 3.3.3 ユーザーインターフェース要件
- **UI-EL-001**: ログイン画面レイアウト: 中央寄せ、シンプルなフォーム
- **UI-EL-002**: 入力項目:
  - 保育園コード（テキスト入力）
  - パスワード（パスワード入力、表示/非表示切り替えボタン付き）
- **UI-EL-003**: ログインボタン: 大きく、視認性の高いデザイン
- **UI-EL-004**: エラーメッセージ表示エリア（ログイン失敗時）
- **UI-EL-005**: ログイン成功後、自動リダイレクト（読み込み中表示）

#### 3.3.4 技術要件
- **TR-EL-001**: 専用ルート: `/entry-exit-login`
- **TR-EL-002**: API エンドポイント: `POST /api/auth/entry-exit-login`
- **TR-EL-003**: レスポンス: JWT トークン、保育園ID、保育園名
- **TR-EL-004**: ログアウト時はトークンを削除し、ログイン画面にリダイレクト

---

### 3.4 管理画面 - 入退ログ一覧表示機能

#### 3.4.1 機能要件
- **FR-AL-001**: デスクトップ管理画面に「入退管理ログ」メニューを追加する
- **FR-AL-002**: 入退ログを一覧表示する（時刻降順）
- **FR-AL-003**: フィルター機能を提供する:
  - 日付範囲（From～To）
  - 保護者名（部分一致検索）
  - 入/出（選択式）
  - 園児名（保護者に紐づく園児で絞り込み）
- **FR-AL-004**: ページネーション機能を提供する（1ページ50件）
- **FR-AL-005**: CSV エクスポート機能を提供する
- **FR-AL-006**: 個別ログの削除機能を提供する（誤スキャン対応）

#### 3.4.2 表示項目要件
- **DI-AL-001**: 表示列:
  - 日時（YYYY-MM-DD HH:mm:ss）
  - 保護者名
  - 入/出（アイコン表示: 緑矢印↓=入、オレンジ矢印↑=出）
  - 関連園児名（カンマ区切りで複数表示）
  - 保育園名（マルチテナント対応）
  - アクション（削除ボタン）

#### 3.4.3 ユーザーインターフェース要件
- **UI-AL-001**: 一覧ページレイアウト: 標準的なテーブル形式
- **UI-AL-002**: フィルターエリア: 画面上部にカード形式で配置
- **UI-AL-003**: テーブルヘッダー: ソート可能（日時列）
- **UI-AL-004**: レスポンシブデザイン: デスクトップ優先（モバイル対応は低優先度）

#### 3.4.4 技術要件
- **TR-AL-001**: 専用ルート: `/desktop/entry-exit-logs`
- **TR-AL-002**: API エンドポイント: `GET /api/entry-exit-logs`
- **TR-AL-003**: クエリパラメータ: `from`, `to`, `parentName`, `entryType`, `page`, `pageSize`

---

### 3.5 出欠管理画面との連携機能

#### 3.5.1 機能要件
- **FR-AD-001**: 出欠管理画面（AttendancePage）に入退ログ情報を表示する
- **FR-AD-002**: 各園児の行に「送り迎え時刻」列を追加する
- **FR-AD-003**: 送り迎え時刻の表示内容:
  - 入（登園）時刻: 「↓ HH:mm」（緑色）
  - 出（降園）時刻: 「↑ HH:mm」（オレンジ色）
  - 複数回の入退がある場合は最新のみ表示
- **FR-AD-004**: 送り迎え時刻をホバーすると、詳細情報をツールチップで表示
  - 保護者名
  - 正確な時刻（秒まで）
  - 入退の履歴（当日の全記録）

#### 3.5.2 ユーザーインターフェース要件
- **UI-AD-001**: 送り迎え時刻列: 出席状態の右隣に配置
- **UI-AD-002**: アイコン + 時刻の組み合わせで視認性を向上
- **UI-AD-003**: ツールチップ: ホバー時に表示、最大5件まで履歴表示

#### 3.5.3 技術要件
- **TR-AD-001**: API エンドポイント拡張: `GET /api/attendance` のレスポンスに入退ログを含める
- **TR-AD-002**: レスポンス構造:
  ```json
  {
    "childId": 123,
    "childName": "山田太郎",
    "attendances": [...],
    "entryExitLogs": [
      {
        "logId": 456,
        "entryType": "Entry",
        "timestamp": "2026-01-14T09:15:32",
        "parentName": "山田花子"
      }
    ]
  }
  ```

---

### 3.6 ハートビート機能（セッション維持）

#### 3.6.1 機能要件
- **FR-HB-001**: 入退登録画面表示中、30秒ごとにサーバーにハートビート信号を送信する
- **FR-HB-002**: ハートビート送信により、JWTトークンの有効期限を自動延長する
- **FR-HB-003**: ハートビート失敗時（ネットワークエラー、サーバーエラー）は3回までリトライする
- **FR-HB-004**: 3回失敗した場合でも、画面表示は継続する（ユーザーに通知のみ）
- **FR-HB-005**: ハートビート成功時は、トークンを更新する（レスポンスに新しいトークンを含める）

#### 3.6.2 技術要件
- **TR-HB-001**: setInterval を使用して30秒ごとにハートビート送信
- **TR-HB-002**: API エンドポイント: `POST /api/auth/heartbeat`
- **TR-HB-003**: リクエストヘッダーに現在のJWTトークンを含める
- **TR-HB-004**: レスポンス: 新しいJWTトークン + 有効期限
- **TR-HB-005**: ハートビート失敗時はコンソールにログ出力（エラー通知は画面に表示しない）
- **TR-HB-006**: コンポーネントアンマウント時に setInterval をクリアする

#### 3.6.3 API仕様
**エンドポイント**: `POST /api/auth/heartbeat`

**リクエストヘッダー**:
```
Authorization: Bearer {JWT_TOKEN}
```

**レスポンス**:
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "expiresAt": "2026-01-14T18:00:00Z"
}
```

**エラーレスポンス**:
- `401 Unauthorized`: トークンが無効または期限切れ → ログイン画面にリダイレクト
- `500 Internal Server Error`: サーバーエラー → リトライ

---

## 4. システム構成

### 4.1 システム全体構成図

```
┌─────────────────────────────────────────────────────────────┐
│                    保護者（スマートフォン）                    │
│  ┌───────────────────────────────────────────────────────┐  │
│  │          保護者アプリ（React PWA）                     │  │
│  │  - 保護者IDバーコード表示画面                          │  │
│  │  - Code128バーコード（JsBarcode）                     │  │
│  └───────────────────────────────────────────────────────┘  │
└────────────────────────┬────────────────────────────────────┘
                         │ HTTPS
                         ↓
┌─────────────────────────────────────────────────────────────┐
│            ASP.NET Core Web API（バックエンド）              │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  認証・入退ログAPI                                      │  │
│  │  - POST /api/auth/entry-exit-login                   │  │
│  │  - POST /api/auth/heartbeat (ハートビート)           │  │
│  │  - POST /api/entry-exit-logs                         │  │
│  │  - GET /api/entry-exit-logs                          │  │
│  │  - DELETE /api/entry-exit-logs/{id}                  │  │
│  │  - GET /api/attendance (拡張: 入退ログ含む)            │  │
│  └───────────────────────────────────────────────────────┘  │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ↓
┌─────────────────────────────────────────────────────────────┐
│                  Azure SQL Database                         │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  EntryExitLogs テーブル                                │  │
│  │  - Id, ParentId, NurseryId, EntryType, Timestamp     │  │
│  └───────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  Nurseries テーブル（拡張）                            │  │
│  │  - EntryExitPassword (新規カラム)                      │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                         ↑
                         │ HTTPS
┌────────────────────────┴────────────────────────────────────┐
│         入退登録端末（タブレット + バーコードスキャナ）       │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  入退登録画面（React）                                  │  │
│  │  - 入退登録ログイン画面                                 │  │
│  │  - 入退登録画面（スキャン + 記録）                      │  │
│  │  - USBバーコードスキャナ入力処理                        │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                         ↑
                         │ Browser
┌────────────────────────┴────────────────────────────────────┐
│               デスクトップ管理画面（React）                   │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  - 入退管理ログ一覧画面                                 │  │
│  │  - 出欠管理画面（入退ログ表示拡張）                      │  │
│  │  - 園情報編集画面（入退パスワード設定）                  │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 コンポーネント構成

#### 4.2.1 フロントエンド
1. **保護者アプリ（モバイル）**
   - `src/mobile/pages/ParentBarcodePage.tsx`: 保護者IDバーコード表示画面
   - バーコードライブラリ: JsBarcode

2. **入退登録画面（タブレット専用）**
   - `src/entry-exit/pages/EntryExitLoginPage.tsx`: ログイン画面
   - `src/entry-exit/pages/EntryExitRegistrationPage.tsx`: 入退登録画面
   - `src/entry-exit/components/ScanFeedback.tsx`: スキャンフィードバックコンポーネント
   - `src/entry-exit/components/ScanHistory.tsx`: スキャン履歴コンポーネント

3. **デスクトップ管理画面**
   - `src/desktop/pages/EntryExitLogsPage.tsx`: 入退ログ一覧画面
   - `src/desktop/pages/AttendancePage.tsx`: 出欠管理画面（拡張）
   - `src/desktop/pages/NurseryInfoPage.tsx`: 園情報編集画面（パスワード設定追加）

#### 4.2.2 バックエンド
1. **Controllers**
   - `EntryExitController.cs`: 入退ログAPI
   - `AuthenticationController.cs`: 入退登録ログインAPI（拡張）

2. **Services**
   - `IEntryExitService.cs` / `EntryExitService.cs`: 入退ログビジネスロジック
   - `IAuthenticationService.cs` / `AuthenticationService.cs`: 認証処理（拡張）

3. **Models**
   - `EntryExitLog.cs`: 入退ログエンティティ
   - `Nursery.cs`: 保育園エンティティ（EntryExitPassword 追加）

4. **DTOs**
   - `EntryExitLogDto.cs`: 入退ログレスポンス
   - `CreateEntryExitLogRequest.cs`: 入退ログ作成リクエスト
   - `EntryExitLoginRequest.cs` / `EntryExitLoginResponse.cs`: ログインリクエスト・レスポンス

---

## 5. データモデル

### 5.1 EntryExitLogs テーブル

**テーブル名**: `EntryExitLogs`
**説明**: 保護者の入退園記録を保存するテーブル

| カラム名 | 型 | NULL許可 | 制約 | 説明 |
|---------|---|---------|------|------|
| Id | INT | NO | PRIMARY KEY, IDENTITY | 入退ログID（主キー） |
| ParentId | INT | NO | FOREIGN KEY → Parents.Id | 保護者ID |
| NurseryId | INT | NO | FOREIGN KEY → Nurseries.Id | 保育園ID |
| EntryType | NVARCHAR(10) | NO | CHECK ('Entry', 'Exit') | 入退種別（Entry=入、Exit=出） |
| Timestamp | DATETIME2 | NO | DEFAULT GETDATE() | 入退時刻（UTC） |
| CreatedAt | DATETIME2 | NO | DEFAULT GETDATE() | レコード作成日時（UTC） |

**インデックス**:
- `IX_EntryExitLogs_ParentId`: ParentId（検索高速化）
- `IX_EntryExitLogs_NurseryId_Timestamp`: NurseryId + Timestamp（一覧取得高速化）
- `IX_EntryExitLogs_Timestamp`: Timestamp（日付範囲検索用）

**外部キー制約**:
- `FK_EntryExitLogs_Parents`: ParentId → Parents.Id（ON DELETE CASCADE）
- `FK_EntryExitLogs_Nurseries`: NurseryId → Nurseries.Id（ON DELETE CASCADE）

### 5.2 Nurseries テーブル拡張

**既存テーブル**: `Nurseries`
**追加カラム**:

| カラム名 | 型 | NULL許可 | 制約 | 説明 |
|---------|---|---------|------|------|
| EntryExitPassword | NVARCHAR(100) | YES | - | 入退登録画面用パスワード（ハッシュ化） |

**備考**:
- パスワードは bcrypt などでハッシュ化して保存
- NULL の場合は入退登録機能が無効（パスワード未設定）

### 5.3 エンティティリレーションシップ図（ER図）

```
┌─────────────────────┐
│     Nurseries       │
│---------------------|
│ Id (PK)             │
│ Name                │
│ Code                │
│ EntryExitPassword   │◄────────┐
└─────────────────────┘         │
          ▲                      │
          │                      │
          │ 1                    │
          │                      │
          │                      │
          │ N                    │
┌─────────┴───────────┐          │
│      Parents        │          │
│---------------------|          │
│ Id (PK)             │          │
│ NurseryId (FK)      │          │
│ Name                │          │
│ PhoneNumber         │          │
└─────────────────────┘          │
          ▲                      │
          │                      │
          │ 1                    │
          │                      │
          │                      │
          │ N                    │
┌─────────┴───────────┐          │
│   EntryExitLogs     │          │
│---------------------|          │
│ Id (PK)             │          │
│ ParentId (FK)       │          │
│ NurseryId (FK) ─────┘
│ EntryType           │
│ Timestamp           │
│ CreatedAt           │
└─────────────────────┘
```

### 5.4 データモデル詳細

#### 5.4.1 EntryExitLog エンティティ

```csharp
public class EntryExitLog
{
    [Key]
    [DatabaseGenerated(DatabaseGeneratedOption.Identity)]
    public int Id { get; set; }

    [Required]
    public int ParentId { get; set; }

    [Required]
    public int NurseryId { get; set; }

    [Required]
    [StringLength(10)]
    public string EntryType { get; set; } = string.Empty; // "Entry" or "Exit"

    [Required]
    public DateTime Timestamp { get; set; } = DateTime.UtcNow;

    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;

    // ナビゲーションプロパティは明示的に無視（EF Core設定）
}
```

#### 5.4.2 Nursery エンティティ拡張

```csharp
public class Nursery
{
    // 既存プロパティ...

    /// <summary>
    /// 入退登録画面用パスワード（bcryptハッシュ化）
    /// </summary>
    [StringLength(100)]
    public string? EntryExitPassword { get; set; }
}
```

---

## 6. ユーザーインターフェース要件

### 6.1 保護者アプリ - 保護者IDバーコード画面

#### 6.1.1 画面レイアウト

```
┌─────────────────────────────────────────┐
│  ← 戻る          入退管理                │ ← ヘッダー
├─────────────────────────────────────────┤
│                                         │
│         山田 花子 様                     │ ← 保護者名（大きく表示）
│                                         │
│  ┌───────────────────────────────────┐  │
│  │                                   │  │
│  │   ║║ ║║║ ║ ║║║ ║║ ║ ║║║ ║║║ ║  │  │ ← バーコード
│  │   ║║ ║║║ ║ ║║║ ║║ ║ ║║║ ║║║ ║  │  │   （Code128）
│  │                                   │  │
│  └───────────────────────────────────┘  │
│                                         │
│             123456                      │ ← 保護者ID（数値）
│                                         │
│  ┌───────────────────────────────────┐  │
│  │ 使い方:                            │  │
│  │ 保育園の入退登録端末のスキャナーに │  │ ← 説明文
│  │ このバーコードをかざしてください。 │  │
│  └───────────────────────────────────┘  │
│                                         │
└─────────────────────────────────────────┘
```

#### 6.1.2 画面仕様
- **背景色**: 白（#FFFFFF）
- **バーコード背景**: 白（#FFFFFF）
- **バーコード前景**: 黒（#000000）
- **保護者名フォント**: 24px, bold
- **保護者IDフォント**: 18px, regular
- **説明文フォント**: 14px, regular
- **画面明るさ**: 自動的に最大に設定（ライブラリまたはCSS）

### 6.2 入退登録画面

#### 6.2.1 ログイン画面レイアウト

```
┌─────────────────────────────────────────┐
│                                         │
│                                         │
│      ┌───────────────────────────┐      │
│      │   入退登録システム         │      │ ← タイトル
│      └───────────────────────────┘      │
│                                         │
│      ┌───────────────────────────┐      │
│      │ 保育園コード:              │      │
│      │ [                    ]    │      │ ← 保育園コード入力
│      └───────────────────────────┘      │
│                                         │
│      ┌───────────────────────────┐      │
│      │ パスワード:                │      │
│      │ [                    ] 👁 │      │ ← パスワード入力
│      └───────────────────────────┘      │    （表示切替）
│                                         │
│      ┌───────────────────────────┐      │
│      │       ログイン             │      │ ← ログインボタン
│      └───────────────────────────┘      │
│                                         │
│      エラーメッセージ表示エリア          │
│                                         │
└─────────────────────────────────────────┘
```

#### 6.2.2 入退登録画面レイアウト（タブレット横向き）

```
┌───────────────────────────────────────────────────────────────────┐
│  🌸 さくら保育園          2026-01-14 09:15:32       [ログアウト]   │ ← ヘッダー
├───────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │  [  入  ]  ←選択中（緑色背景）                              │    │ ← 入/出トグル
│  │  [  出  ]                                                  │    │
│  └──────────────────────────────────────────────────────────┘    │
│                                                                   │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │                                                            │    │
│  │             バーコードをスキャンしてください               │    │ ← スキャン待機
│  │                                                            │    │   メッセージ
│  │                        📷                                  │    │
│  │                                                            │    │
│  └──────────────────────────────────────────────────────────┘    │
│                                                                   │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │  最近のスキャン履歴:                                        │    │
│  │  ┌──────┬─────────┬──────┬─────────┐                     │    │
│  │  │ 時刻  │ 保護者名 │ 入/出 │ ステータス│                    │    │ ← スキャン履歴
│  │  ├──────┼─────────┼──────┼─────────┤                     │    │
│  │  │09:14 │ 山田花子 │  ↓   │  成功    │                    │    │
│  │  │09:12 │ 佐藤太郎 │  ↑   │  成功    │                    │    │
│  │  │09:10 │ 鈴木次郎 │  ↓   │  成功    │                    │    │
│  │  └──────┴─────────┴──────┴─────────┘                     │    │
│  └──────────────────────────────────────────────────────────┘    │
│                                                                   │
└───────────────────────────────────────────────────────────────────┘
```

#### 6.2.3 スキャン成功時のフィードバック

**「入」の場合:**
```
┌───────────────────────────────────────────────────────────────────┐
│  画面全体が緑色にフラッシュ（200ms）                               │
├───────────────────────────────────────────────────────────────────┤
│                                                                   │
│                                                                   │
│                                                                   │
│                  山田 花子さん。                                  │ ← 大きく表示
│                おはようございます。                                │    （3秒間）
│                                                                   │
│                                                                   │
│                                                                   │
│                                                                   │
└───────────────────────────────────────────────────────────────────┘
```

**「出」の場合:**
```
┌───────────────────────────────────────────────────────────────────┐
│  画面全体が緑色にフラッシュ（200ms）                               │
├───────────────────────────────────────────────────────────────────┤
│                                                                   │
│                                                                   │
│                                                                   │
│                  山田 花子さん。                                  │ ← 大きく表示
│                お疲れ様でした。                                    │    （3秒間）
│                                                                   │
│                                                                   │
│                                                                   │
│                                                                   │
└───────────────────────────────────────────────────────────────────┘
```

### 6.3 デスクトップ管理画面 - 入退ログ一覧

#### 6.3.1 画面レイアウト

```
┌─────────────────────────────────────────────────────────────────┐
│  入退管理ログ                                   [CSVエクスポート] │ ← ヘッダー
├─────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ フィルター:                                                │  │
│  │  期間: [2026-01-01] ～ [2026-01-31]                        │  │
│  │  保護者名: [          ]  入/出: [すべて ▼]                 │  │ ← フィルター
│  │  園児名: [          ]                       [検索]         │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ 日時              │保護者名│ 入/出│ 関連園児    │ アクション│  │
│  ├───────────────────────────────────────────────────────────┤  │
│  │ 2026-01-14 09:15 │山田花子│  ↓  │ 山田太郎    │ [削除]   │  │
│  │ 2026-01-14 09:12 │佐藤太郎│  ↑  │ 佐藤次郎    │ [削除]   │  │ ← テーブル
│  │ 2026-01-14 09:10 │鈴木次郎│  ↓  │ 鈴木花子    │ [削除]   │  │
│  │ ...              │        │      │             │          │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│                      [前へ] 1 / 10 [次へ]                        │ ← ページネーション
└─────────────────────────────────────────────────────────────────┘
```

### 6.4 出欠管理画面の拡張

#### 6.4.1 送り迎え時刻列の追加

```
┌─────────────────────────────────────────────────────────────────┐
│  出欠表管理                                     [詳細レポート]    │
├─────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ 園児名    │ 出席状態 │ 送り迎え時刻 │ 備考                  │  │
│  ├───────────────────────────────────────────────────────────┤  │
│  │ 山田太郎  │   出席   │ ↓ 09:15     │                      │  │ ← 緑色矢印
│  │ 佐藤次郎  │   欠席   │              │ 風邪のため            │  │
│  │ 鈴木花子  │   出席   │ ↓ 09:10     │                      │  │
│  │           │          │ ↑ 15:30     │                      │  │ ← オレンジ矢印
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

#### 6.4.2 ツールチップ（ホバー時）

```
┌───────────────────────────┐
│ 送り迎え履歴:             │
│                           │
│ 保護者: 山田花子          │
│ 09:15:32 入（登園）       │
│ 15:30:15 出（降園）       │
└───────────────────────────┘
```

---

## 7. セキュリティ要件

### 7.1 認証・認可
- **SEC-001**: 入退登録画面へのアクセスは、保育園コード+パスワード認証が必須
- **SEC-002**: JWT トークンの有効期限は8時間（保育園の営業時間を考慮）
- **SEC-003**: ログイン試行は5回まで、6回目以降は10分間ロックアウト
- **SEC-004**: パスワードは bcrypt でハッシュ化して保存（コストファクタ: 12）
- **SEC-005**: 入退ログAPIは、保育園IDによるマルチテナント分離を実施

### 7.2 データ保護
- **SEC-006**: 入退ログは論理削除のみ（物理削除は管理者権限のみ）
- **SEC-007**: 入退ログの編集は不可（誤スキャン時は削除→再スキャン）
- **SEC-008**: バーコードデータ（保護者ID）は数値のみ、1～10桁に制限
- **SEC-009**: HTTPS 通信必須（HTTP はリダイレクト）

### 7.3 オフライン対応
- **SEC-010**: オフライン時のデータ蓄積は最大100件まで
- **SEC-011**: オンライン復帰時、蓄積データを順次送信（重複チェック実施）
- **SEC-012**: 送信失敗時は最大3回までリトライ

---

## 8. 非機能要件

### 8.1 パフォーマンス要件
- **NFR-P-001**: バーコードスキャンから記録完了まで2秒以内
- **NFR-P-002**: 入退ログ一覧の初回表示は3秒以内（50件）
- **NFR-P-003**: 保護者アプリのバーコード表示は1秒以内
- **NFR-P-004**: 出欠管理画面の入退ログ表示は追加で1秒以内（既存の出席データと同時取得）

### 8.2 可用性要件
- **NFR-A-001**: システム稼働率は99.5%以上（月次）
- **NFR-A-002**: オフライン時でもローカルデータ蓄積により業務継続可能
- **NFR-A-003**: データベース障害時はエラーメッセージを明示し、手動記録を促す

### 8.3 拡張性要件
- **NFR-S-001**: 1保育園あたり最大500名の保護者に対応
- **NFR-S-002**: 1日あたり最大2000件の入退ログに対応
- **NFR-S-003**: 過去1年分の入退ログを保持（それ以前はアーカイブ）

### 8.4 ユーザビリティ要件
- **NFR-U-001**: スキャン成功時のフィードバックは200ms以内に開始
- **NFR-U-002**: エラーメッセージは具体的で、対処法を含む
- **NFR-U-003**: タブレット画面は屋外でも視認可能な明るさ（輝度最大）

### 8.5 互換性要件
- **NFR-C-001**: USBバーコードスキャナはキーボードエミュレーションモード対応
- **NFR-C-002**: バーコードフォーマットはCode128（GS1-128も対応可能）
- **NFR-C-003**: タブレットはAndroid 8.0+、iOS 12.0+ のブラウザに対応

---

## 9. 制約事項

### 9.1 技術的制約
- **CON-T-001**: バーコードスキャナは USB 接続のみ対応（Bluetooth非対応）
- **CON-T-002**: カメラによるバーコード読み取りは非対応（スキャナ必須）
- **CON-T-003**: 入退登録画面はタブレット専用（スマートフォン非対応）
- **CON-T-004**: オフラインデータは IndexedDB または localStorage に保存（容量制限あり）

### 9.2 業務的制約
- **CON-B-001**: 入退登録は保護者のみ対象（職員・訪問者は対象外）
- **CON-B-002**: 入退ログの修正は不可（削除→再登録のみ）
- **CON-B-003**: 保育園コード+パスワードは保育園ごとに1つのみ（端末ごとのパスワードは不可）

### 9.3 運用制約
- **CON-O-001**: 入退登録端末は保育園の入口に固定設置
- **CON-O-002**: バーコードスキャナの定期的な動作確認が必要（月1回）
- **CON-O-003**: 保護者への事前説明とバーコード表示方法の周知が必要

---

## 10. 今後の拡張性

### 10.1 短期的拡張（3ヶ月以内）
- **FE-ST-001**: QRコード対応（Code128に加えてQRコードも読み取り可能に）
- **FE-ST-002**: 顔認証連携（バーコード+顔認証で二要素認証）
- **FE-ST-003**: プッシュ通知（保護者が入退した際に園児の担任に通知）

### 10.2 中期的拡張（6ヶ月以内）
- **FE-MT-001**: 訪問者管理（保護者以外の訪問者も記録）
- **FE-MT-002**: 職員の出退勤管理（保護者と同じ仕組みで職員も管理）
- **FE-MT-003**: 統計レポート機能（入退時刻の統計、混雑時間帯の可視化）

### 10.3 長期的拡張（1年以内）
- **FE-LT-001**: AI による異常検知（通常と異なる入退パターンの検出）
- **FE-LT-002**: 他システム連携（会計システムと連携し、延長保育料の自動計算）
- **FE-LT-003**: マルチデバイス対応（スマートフォンでもバーコードスキャン可能に）

---

## 付録

### 付録A: API仕様書（概要）

#### A.1 入退ログ作成API
- **エンドポイント**: `POST /api/entry-exit-logs`
- **リクエストボディ**:
  ```json
  {
    "parentId": 123,
    "nurseryId": 1,
    "entryType": "Entry"
  }
  ```
- **レスポンス**:
  ```json
  {
    "id": 456,
    "parentId": 123,
    "parentName": "山田花子",
    "nurseryId": 1,
    "entryType": "Entry",
    "timestamp": "2026-01-14T09:15:32Z",
    "childNames": ["山田太郎", "山田次郎"]
  }
  ```

#### A.2 入退ログ一覧取得API
- **エンドポイント**: `GET /api/entry-exit-logs`
- **クエリパラメータ**: `from`, `to`, `parentName`, `entryType`, `page`, `pageSize`
- **レスポンス**:
  ```json
  {
    "logs": [
      {
        "id": 456,
        "parentName": "山田花子",
        "entryType": "Entry",
        "timestamp": "2026-01-14T09:15:32Z",
        "childNames": ["山田太郎"]
      }
    ],
    "totalCount": 100,
    "page": 1,
    "pageSize": 50
  }
  ```

#### A.3 入退登録ログインAPI
- **エンドポイント**: `POST /api/auth/entry-exit-login`
- **リクエストボディ**:
  ```json
  {
    "nurseryCode": "ABC123",
    "password": "password123"
  }
  ```
- **レスポンス**:
  ```json
  {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "nurseryId": 1,
    "nurseryName": "さくら保育園",
    "expiresAt": "2026-01-14T18:00:00Z"
  }
  ```

#### A.4 ハートビートAPI
- **エンドポイント**: `POST /api/auth/heartbeat`
- **リクエストヘッダー**:
  ```
  Authorization: Bearer {JWT_TOKEN}
  ```
- **リクエストボディ**: なし
- **レスポンス**:
  ```json
  {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "expiresAt": "2026-01-14T18:00:00Z"
  }
  ```

### 付録B: バーコード仕様

- **形式**: Code128
- **データ**: 保護者ID（数値のみ、例: `123456`）
- **サイズ**: 横幅 300px、高さ 150px（推奨）
- **背景色**: 白（#FFFFFF）
- **前景色**: 黒（#000000）
- **マージン**: 上下左右 10px

### 付録C: データベースマイグレーションスクリプト

```sql
-- EntryExitLogs テーブル作成
CREATE TABLE EntryExitLogs (
    Id INT PRIMARY KEY IDENTITY(1,1),
    ParentId INT NOT NULL,
    NurseryId INT NOT NULL,
    EntryType NVARCHAR(10) NOT NULL CHECK (EntryType IN ('Entry', 'Exit')),
    Timestamp DATETIME2 NOT NULL DEFAULT GETDATE(),
    CreatedAt DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT FK_EntryExitLogs_Parents FOREIGN KEY (ParentId) REFERENCES Parents(Id) ON DELETE CASCADE,
    CONSTRAINT FK_EntryExitLogs_Nurseries FOREIGN KEY (NurseryId) REFERENCES Nurseries(Id) ON DELETE CASCADE
);

-- インデックス作成
CREATE INDEX IX_EntryExitLogs_ParentId ON EntryExitLogs(ParentId);
CREATE INDEX IX_EntryExitLogs_NurseryId_Timestamp ON EntryExitLogs(NurseryId, Timestamp DESC);
CREATE INDEX IX_EntryExitLogs_Timestamp ON EntryExitLogs(Timestamp DESC);

-- Nurseries テーブルにカラム追加
ALTER TABLE Nurseries ADD EntryExitPassword NVARCHAR(100) NULL;
```

---

## 変更履歴

| バージョン | 日付 | 変更者 | 変更内容 |
|-----------|------|--------|---------|
| 1.0 | 2026-01-14 | Claude | 初版作成 |
| 1.1 | 2026-01-14 | Claude | スキャン成功時のメッセージ変更（おはようございます/お疲れ様でした）、音声フィードバック削除、ハートビート機能追加 |

---

**END OF DOCUMENT**
