# 撮影禁止(NoPhoto)機能 要件定義書

## 1. 機能概要

### 1.1 目的
保護者が園児の写真共有を望まない場合に、写真の撮影・共有を禁止する設定を管理する機能を提供する。これにより、プライバシー保護とコンプライアンス要件を満たす。

### 1.2 対象範囲
- 入園申込時の撮影禁止設定
- 園児マスタでの撮影禁止設定の管理
- 写真アップロード時の検証と警告

## 2. データベーススキーマ

### 2.1 ApplicationWorksテーブル
| カラム名 | データ型 | NULL許可 | デフォルト値 | 説明 |
|---------|---------|----------|-------------|------|
| ChildNoPhoto | BIT | NOT NULL | 0 | 撮影禁止フラグ（申込時）<br>1=撮影禁止を希望、0=撮影可（デフォルト） |

**設計意図**:
- デフォルト値を `0` (FALSE) に設定することで、基本的には写真撮影・共有を許可する
- 保護者が撮影禁止を希望する場合のみチェックを入れて `1` (TRUE) に設定
- 入園申込時に一度だけ設定される

### 2.2 Childrenテーブル
| カラム名 | データ型 | NULL許可 | デフォルト値 | 説明 |
|---------|---------|----------|-------------|------|
| NoPhoto | BIT | NOT NULL | 0 | 撮影禁止フラグ（園児マスタ）<br>1=撮影禁止、0=撮影可 |

**設計意図**:
- デフォルト値を `0` (FALSE) に設定することで、既存データとの互換性を維持
- 入園後も編集可能な運用フラグ
- 申込データからの移行時に `ApplicationWorks.ChildNoPhoto` の値を引き継ぐ

### 2.3 データフロー
```
入園申込
  ↓
ApplicationWorks.ChildNoPhoto (デフォルト: 0/FALSE - 撮影・共有を許可)
  ↓ 申込承認・園児登録時
Children.NoPhoto (ApplicationWorks.ChildNoPhotoの値を引き継ぐ)
  ↓ 入園後
編集可能（保護者・職員が変更可能）
```

## 3. ビジネスルール

### 3.1 入園申込時
- 申込フォームに写真共有に関する説明文とチェックボックスを表示
- **説明文**: 写真共有の目的とメリット、安全性について分かりやすく説明
  - 例: 「当園では、保育園での日常の様子や行事の写真を専用アプリを通じて保護者の皆様と共有しています。アプリは保護者のみがアクセス可能で、お子様の成長記録を安全にご覧いただけます。クラスの集合写真なども含まれますので、ぜひご活用ください。」
- チェックボックスのラベル: **「写真の撮影・共有を希望しない（チェックを入れた場合、お子様が写った写真は共有されません）」**
- チェック状態: デフォルトで**チェック無し** (ChildNoPhoto = 0 - 撮影・共有を許可)
- 保護者が撮影禁止を希望する場合のみチェックを入れる (ChildNoPhoto = 1)

### 3.2 園児登録・インポート時
- `ApplicationWorks.ChildNoPhoto` の値を `Children.NoPhoto` に移行
- 既存の園児データ（NoPhotoカラム追加前）はデフォルト値 `0` (撮影可) として扱う

### 3.3 園児情報編集時
- 園児マスタ編集画面でNoPhoto設定を変更可能
- 変更権限: 保護者本人、職員（管理者・教職員）
- 変更履歴のログは不要（現在の状態のみ管理）

### 3.4 写真アップロード時
- 職員が写真をアップロードする際、選択した園児の中に `NoPhoto = 1` の園児が含まれる場合、警告を表示
- 警告内容:
  - 撮影禁止設定の園児名リストを表示
  - アップロード続行の可否を確認
  - 確認後もアップロード可能（警告のみで禁止ではない）

**警告例**:
```
⚠️ 撮影禁止設定の園児が含まれています

以下の園児は撮影禁止設定がされています：
- 田中太郎
- 佐藤花子

この写真には上記の園児が映っていないことを確認してください。
このままアップロードしますか？

[キャンセル] [アップロード]
```

## 4. UI要件

### 4.1 入園申込フォーム
**場所**: `reactapp.client/src/components/ApplicationForm.tsx` (推定)

**追加要素**:
```tsx
{/* 写真共有に関する説明文 */}
<Box sx={{ mb: 2, p: 2, bgcolor: 'info.light', borderRadius: 1 }}>
  <Typography variant="body2">
    {t('application.photoSharing.description')}
    {/* 例: 「当園では、保育園での日常の様子や行事の写真を専用アプリを通じて
         保護者の皆様と共有しています。アプリは保護者のみがアクセス可能で、
         お子様の成長記録を安全にご覧いただけます。クラスの集合写真なども
         含まれますので、ぜひご活用ください。」 */}
  </Typography>
</Box>

{/* 撮影禁止チェックボックス */}
<FormControlLabel
  control={
    <Checkbox
      name="childNoPhoto"
      checked={formData.childNoPhoto}
      onChange={handleCheckboxChange}
    />
  }
  label={t('application.childNoPhoto.label')}
  {/* 例: 「写真の撮影・共有を希望しない（チェックを入れた場合、
       お子様が写った写真は共有されません）」 */}
/>
```

**デフォルト状態**: `checked={false}` (チェック無し - 撮影・共有を許可)

### 4.2 園児登録・編集画面
**場所**: 園児マスタ管理画面 (要調査)

**追加要素**:
```tsx
<FormControlLabel
  control={
    <Checkbox
      name="noPhoto"
      checked={childData.noPhoto}
      onChange={handleNoPhotoChange}
    />
  }
  label="撮影禁止"
/>
```

### 4.3 写真アップロード画面
**場所**: 写真アップロード機能 (PhotoService関連)

**追加機能**:
1. 園児選択時にNoPhotoフラグをチェック
2. NoPhoto=1の園児が含まれる場合、警告ダイアログを表示
3. 警告ダイアログで園児名リストを表示
4. ユーザーがキャンセルまたは続行を選択

## 5. API要件

### 5.1 入園申込API
**エンドポイント**: `POST /api/applications` (推定)

**リクエストボディ追加項目**:
```json
{
  "childNoPhoto": false
}
```

**注**: デフォルト値は `false` (撮影・共有を許可)

### 5.2 園児情報取得API
**エンドポイント**: `GET /api/children/{id}`

**レスポンスボディ追加項目**:
```json
{
  "noPhoto": false
}
```

### 5.3 園児情報更新API
**エンドポイント**: `PUT /api/children/{id}`

**リクエストボディ追加項目**:
```json
{
  "noPhoto": true
}
```

### 5.4 写真アップロード検証API (新規)
**エンドポイント**: `POST /api/photos/validate-children`

**リクエストボディ**:
```json
{
  "childIds": [1, 2, 3]
}
```

**レスポンスボディ**:
```json
{
  "hasNoPhotoChildren": true,
  "noPhotoChildren": [
    {
      "childId": 2,
      "name": "田中太郎"
    }
  ]
}
```

または、既存の写真アップロードAPI内で検証を実装し、警告情報を返す。

## 6. セキュリティ・プライバシー考慮事項

### 6.1 アクセス制御
- NoPhoto設定の閲覧: 保護者本人、職員（全権限）
- NoPhoto設定の変更: 保護者本人、職員（管理者・教職員）
- 写真アップロード警告: 職員のみ

### 6.2 データ保護
- NoPhotoフラグは個人情報として扱う
- API経由での不正なアクセスを防止（認証・認可必須）

### 6.3 コンプライアンス
- 保護者の明示的な同意なしにNoPhoto設定を解除しない
- NoPhoto設定の園児が映った写真を共有しない（職員の責任）

## 7. テスト要件

### 7.1 単体テスト
- ApplicationWork モデルの ChildNoPhoto プロパティのデフォルト値検証
- Child モデルの NoPhoto プロパティのデフォルト値検証
- DTO のマッピング検証

### 7.2 統合テスト
- 入園申込API: ChildNoPhoto=0 (デフォルト) でデータが保存されることを確認
- 入園申込API: ChildNoPhoto=1 (チェック有り) でデータが保存されることを確認
- 園児登録時: ApplicationWorks.ChildNoPhoto → Children.NoPhoto への移行確認
- 園児更新API: NoPhoto の更新が正しく反映されることを確認

### 7.3 E2Eテスト
- 入園申込フォームで説明文が表示されることを確認
- 入園申込フォームでチェックボックスがデフォルトで**チェック無し**であることを確認
- チェックを入れて申込後、ChildNoPhoto=1 で保存されることを確認
- チェック無しのまま申込後、ChildNoPhoto=0 で保存されることを確認
- 園児編集画面でNoPhoto設定を変更し、保存されることを確認
- NoPhoto=1の園児を選択して写真をアップロード時、警告が表示されることを確認

### 7.4 UIテスト
- 入園申込フォームのチェックボックスの表示・動作確認
- 園児編集画面のチェックボックスの表示・動作確認
- 写真アップロード警告ダイアログの表示・動作確認

## 8. 非機能要件

### 8.1 パフォーマンス
- 写真アップロード時のNoPhotoチェックは高速に実行（100ms以内）
- 園児リストのNoPhoto情報は効率的にクエリ（インデックス不要と判断）

### 8.2 ユーザビリティ
- チェックボックスのラベルは明確で理解しやすい
- 警告ダイアログは視覚的に目立つデザイン（⚠️アイコン使用）
- 保護者が安心して設定できるUI

### 8.3 保守性
- NoPhotoフラグの変更履歴は不要（現在の状態のみ管理）
- 将来的な拡張性を考慮（例: 撮影禁止理由の記録）

## 9. 制約事項

### 9.1 技術的制約
- データベースはすでに更新済み（ApplicationWorks.ChildNoPhoto, Children.NoPhoto追加済み）
- 既存の写真データには影響を与えない（過去の写真は対象外）

### 9.2 運用上の制約
- NoPhoto設定は職員の判断を支援するものであり、技術的に写真アップロードを禁止するものではない
- 職員が誤って撮影禁止の園児が映った写真をアップロードした場合、手動で削除する必要がある

## 10. 今後の拡張可能性

- 撮影禁止理由の記録（宗教的理由、肖像権、いじめ防止等）
- 写真アップロード時の自動顔認識とNoPhoto園児の検出（AI活用）
- 保護者への通知機能（NoPhoto設定の園児が映った写真がアップロードされた場合）
- NoPhoto設定の有効期限管理（一時的な撮影禁止）
