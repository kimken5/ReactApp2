# 出欠表機能 要件定義書

## 1. 機能概要

スタッフが担当クラスの園児の日次出欠状況を管理・記録する機能。
保護者からの欠席・遅刻連絡と連携し、出欠状況をリアルタイムで把握・更新できるシステム。

## 2. 背景と目的

### 2.1 背景
- 保護者からの欠席・遅刻連絡を受けても、出欠状況が自動的に反映されない
- 手動での出欠記録が必要で、記録漏れや二重管理が発生
- 過去の出欠履歴を確認する手段がない

### 2.2 目的
- 保護者からの連絡と出欠記録の連携による業務効率化
- クラス全体の出欠状況の一覧表示による視認性向上
- 出欠履歴の記録による統計分析の基盤構築

## 3. 主要機能

### 3.1 出欠表表示機能

#### 3.1.1 画面構成
**ヘッダー部分**（連絡確認画面と同様のデザイン）
- 左側: 戻るボタン
- 中央: 日付表示と日付スライド機能
  - 「< 11月14日（木） >」形式
  - 矢印クリックで前日/翌日に移動
  - デフォルトは「今日」
- 右側: クラス名表示

**メイン部分**
- 縦スクロール可能な園児一覧
- 各園児行の構成:
  - 園児名（左寄せ）
  - アイコン群（中央）
    - 📧 連絡アイコン（欠席・遅刻連絡がある場合のみ表示）
    - 📝 備考アイコン（備考が入力されている場合のみ表示）
  - 出欠ステータス（右寄せ、タップで切り替え）

**フッター部分**
- 「空白を一括出席」ボタン
  - 空白ステータスの園児を一括で「出席」に変更

#### 3.1.2 出欠ステータス
| ステータス | 表示 | 説明 | 背景色 |
|---------|------|------|--------|
| 空白（未記録） | - | 出欠が未記録の状態 | 白/グレー |
| 出席 | 出席 | 登園済み | 緑 |
| 欠席 | 欠席 | 終日欠席 | 赤 |
| 遅刻 | 遅刻 | 遅刻して登園 | オレンジ |

### 3.2 出欠記録機能

#### 3.2.1 手動記録（ステータス切り替え）
- ステータス部分をタップ/クリック
- タップごとに順次切り替わる
  - 空白 → 出席 → 欠席 → 遅刻 → 空白 → ...
- 変更後、即座に保存・反映

#### 3.2.2 連絡内容確認
- 📧連絡アイコンをタップ
- モーダルで連絡内容を表示
  - 提出日時
  - 連絡種別（欠席/遅刻）
  - 理由
  - 期間（開始日〜終了日）
  - 追加メモ
  - 到着予定時刻（遅刻の場合）

#### 3.2.3 備考入力
- 📝備考アイコンまたは園児名をタップ
- モーダルで備考入力欄を表示
- 最大500文字まで入力可能
- 保存後、備考がある園児には📝アイコン表示
- 備考を削除すると📝アイコンも非表示

#### 3.2.4 自動記録（連絡確認画面との連携）
連絡確認画面で欠席・遅刻連絡を「確認」処理した場合:
1. 該当日の出欠表に自動反映
2. 欠席連絡 → 「欠席」ステータス
3. 遅刻連絡 → 「遅刻」ステータス

**連携フロー**
```
保護者が欠席/遅刻連絡送信
  ↓
連絡確認画面に表示
  ↓
スタッフが「確認」ボタンをクリック
  ↓
AbsenceNotification.Status = "acknowledged"
  ↓
DailyAttendance.Status = "absent" or "late" (自動設定)
  ↓
出欠表に反映
```

#### 3.2.5 一括出席機能
- 「空白を一括出席」ボタンをクリック
- 確認ダイアログ表示
  - 「○名の園児を出席にしますか？」
- OKで全ての空白ステータス → 「出席」

### 3.3 履歴管理機能

#### 3.3.1 日付切り替え
- ヘッダーの矢印で前日/翌日に移動
- 過去の出欠記録をいつまでも表示可能（制限なし）
- 未来の日付は選択可能（事前記録用）

#### 3.3.2 記録の更新
- 既存のステータスは上書き可能
- 更新時にUpdatedAtフィールドを更新
- 更新者（StaffId）を記録

## 4. データベース設計

### 4.1 新規テーブル: DailyAttendances

```sql
CREATE TABLE DailyAttendances (
    -- 複合主キー
    NurseryId INT NOT NULL,
    ChildId INT NOT NULL,
    AttendanceDate DATE NOT NULL,

    PRIMARY KEY (NurseryId, ChildId, AttendanceDate),

    -- ステータス
    Status NVARCHAR(20) NOT NULL DEFAULT 'blank',  -- blank, present, absent, late

    -- 追加情報
    ArrivalTime TIME NULL,                         -- 登園時刻（出席・遅刻の場合）
    Notes NVARCHAR(500) NULL,                      -- 備考

    -- 連携情報
    AbsenceNotificationId INT NULL,                -- 欠席連絡ID（連絡から自動設定された場合）

    -- 記録者情報
    RecordedByStaffId INT NULL,                    -- 記録したスタッフID
    RecordedByStaffNurseryId INT NULL,             -- 記録したスタッフの保育園ID

    -- タイムスタンプ
    CreatedAt DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    RecordedAt DATETIME2 NOT NULL DEFAULT GETUTCDATE(),

    -- 更新情報
    UpdatedByStaffId INT NULL,                     -- 更新したスタッフID
    UpdatedByStaffNurseryId INT NULL,              -- 更新したスタッフの保育園ID
    UpdatedAt DATETIME2 NULL,

    -- 論理削除
    IsActive BIT NOT NULL DEFAULT 1,

);

-- インデックス
CREATE INDEX IX_DailyAttendances_Date
    ON DailyAttendances(AttendanceDate);

CREATE INDEX IX_DailyAttendances_Status
    ON DailyAttendances(Status);

CREATE INDEX IX_DailyAttendances_AbsenceNotification
    ON DailyAttendances(AbsenceNotificationId);
```

### 4.2 既存テーブルの活用

#### AbsenceNotifications（既存）
- 欠席・遅刻連絡の情報源
- Status = 'acknowledged' の時にDailyAttendancesを自動作成

**主要カラム**
- Id: 連絡ID
- NurseryId, ChildId: 対象園児
- NotificationType: 'absence' or 'lateness'
- StartDate: 欠席/遅刻の対象日
- Status: 'submitted', 'acknowledged', 'replied'
- AcknowledgedAt: 確認日時
- AcknowledgedBy: 確認したスタッフID

## 5. API設計

### 5.1 出欠記録取得API

```
GET /api/Attendance/daily
```

**Query Parameters**
- `date` (required): 対象日 (YYYY-MM-DD形式)
- `classId` (optional): クラスID（指定なしの場合は担当クラス全て）

**Response**
```json
{
  "success": true,
  "data": {
    "date": "2025-11-14",
    "className": "さくら4歳児",
    "attendances": [
      {
        "childId": 10,
        "childName": "田中太郎",
        "status": "present",
        "arrivalTime": "09:00",
        "notes": null,
        "recordedAt": "2025-11-14T00:15:00Z",
        "updatedAt": null,
        "absenceNotification": null
      },
      {
        "childId": 11,
        "childName": "鈴木花子",
        "status": "absent",
        "arrivalTime": null,
        "notes": "風邪のため",
        "recordedAt": "2025-11-14T00:10:00Z",
        "updatedAt": null,
        "absenceNotification": {
          "id": 123,
          "notificationType": "absence",
          "reason": "風邪",
          "startDate": "2025-11-14",
          "endDate": "2025-11-15",
          "additionalNotes": "熱が38度",
          "submittedAt": "2025-11-14T08:00:00Z"
        }
      }
    ],
    "summary": {
      "total": 20,
      "present": 15,
      "absent": 3,
      "late": 2,
      "blank": 0
    }
  }
}
```

### 5.2 出欠記録更新API（ステータス変更）

```
PUT /api/Attendance/daily/{childId}
```

**Request Body**
```json
{
  "date": "2025-11-14",
  "status": "present",
  "arrivalTime": "09:15"
}
```

**Response**
```json
{
  "success": true,
  "data": {
    "nurseryId": 1,
    "childId": 10,
    "attendanceDate": "2025-11-14",
    "status": "late",
    "updatedAt": "2025-11-14T01:00:00Z"
  }
}
```

### 5.3 備考更新API

```
PUT /api/Attendance/daily/{childId}/notes
```

**Request Body**
```json
{
  "date": "2025-11-14",
  "notes": "午前中体調不良のため保健室で休憩"
}
```

**Response**
```json
{
  "success": true,
  "data": {
    "nurseryId": 1,
    "childId": 10,
    "attendanceDate": "2025-11-14",
    "notes": "午前中体調不良のため保健室で休憩",
    "updatedAt": "2025-11-14T01:00:00Z"
  }
}
```

### 5.4 一括出席記録API

```
POST /api/Attendance/bulk-present
```

**Request Body**
```json
{
  "date": "2025-11-14",
  "classId": "SAKURA-4"
}
```

**Response**
```json
{
  "success": true,
  "data": {
    "updatedCount": 15,
    "childIds": [1, 2, 3, ...]
  }
}
```

## 6. 画面設計

### 6.1 レイアウト

```
┌─────────────────────────────────────────────┐
│ ← 11月14日（木） >      さくら4歳児         │ ← ヘッダー
├─────────────────────────────────────────────┤
│ 田中太郎                             出席   │
│ 鈴木花子               📧📝           欠席   │ ← 連絡+備考あり
│ 佐藤一郎               📧             遅刻   │ ← 連絡あり
│ 高橋美咲               📝               -   │ ← 備考のみ
│ 伊藤健太                             出席   │
│ ...                                         │
│                                             │
│                                             │
├─────────────────────────────────────────────┤
│            [空白を一括出席]                  │ ← フッター
└─────────────────────────────────────────────┘
```

### 6.2 インタラクション

#### 6.2.1 ステータス変更
1. ステータス部分をタップ
2. 直接ステータスが切り替わる（空白 → 出席 → 欠席 → 遅刻 → 空白...）
3. 変更後、即座に保存

#### 6.2.2 連絡内容確認（連絡アイコンをクリック）
1. 連絡アイコン（📧）をタップ
2. モーダルで連絡内容を表示
   ```
   ┌────────────────────────────┐
   │ 欠席連絡                    │
   │                            │
   │ 提出日時: 2025-11-14 8:00  │
   │ 理由: 風邪                  │
   │ 期間: 11/14 - 11/15        │
   │ 追加メモ: 熱が38度         │
   │                            │
   │        [閉じる]             │
   └────────────────────────────┘
   ```

#### 6.2.3 備考入力（備考アイコンをクリック）
1. 備考アイコン（📝）をタップ、または園児名をタップ
2. モーダルで備考入力欄を表示
   ```
   ┌────────────────────────────┐
   │ 田中太郎 - 備考入力         │
   │                            │
   │ ┌────────────────────────┐ │
   │ │ 午前中体調不良           │ │
   │ │                        │ │
   │ └────────────────────────┘ │
   │                            │
   │   [キャンセル]  [保存]      │
   └────────────────────────────┘
   ```
3. 保存後、備考がある園児には備考アイコン表示

#### 6.2.2 一括出席
1. 「空白を一括出席」ボタンをクリック
2. 確認ダイアログ
   ```
   ┌────────────────────────────┐
   │ 15名の園児を出席にします。   │
   │ よろしいですか？            │
   │                            │
   │  [キャンセル]  [OK]         │
   └────────────────────────────┘
   ```
3. OK → 一括更新実行

### 6.3 カラースキーム

| ステータス | 背景色 | テキスト色 |
|---------|--------|----------|
| 空白 | #F3F4F6 | #6B7280 |
| 出席 | #D1FAE5 | #065F46 |
| 欠席 | #FEE2E2 | #991B1B |
| 遅刻 | #FED7AA | #92400E |

## 7. ビジネスロジック

### 7.1 出欠記録の優先順位

1. **手動記録が最優先**
   - スタッフが手動で設定した記録は、自動連携より優先
   - UpdatedAtで最新の記録を判定

2. **連絡確認時の自動設定**
   - AbsenceNotificationが「確認」された時
   - DailyAttendanceが未作成の場合のみ自動作成
   - 既存の記録がある場合は上書きしない

3. **一括出席の動作**
   - ステータスが「空白」の園児のみ対象
   - 既に「出席」「欠席」「遅刻」が設定されている園児は対象外

### 7.2 連絡確認画面との連携ロジック

```
【確認処理フロー】
1. スタッフが連絡確認画面で「確認」ボタンをクリック
   ↓
2. AbsenceNotificationController.AcknowledgeNotification()
   ↓
3. AbsenceNotification.Status = "acknowledged"
   AbsenceNotification.AcknowledgedAt = 現在時刻
   AbsenceNotification.AcknowledgedBy = スタッフID
   ↓
4. DailyAttendanceService.CreateFromAbsenceNotification()
   - StartDateをAttendanceDateに設定
   - NotificationType == "absence" → Status = "absent"
   - NotificationType == "lateness" → Status = "late"
   - AbsenceNotificationId = 連絡ID
   - RecordedByStaffId = 確認したスタッフID
   ↓
5. 出欠表に自動反映
```

### 7.3 データ整合性の保証

**制約**
1. 同一園児・同一日の記録は1件のみ（UNIQUE制約）
2. 欠席/遅刻連絡と出欠記録の紐付け（AbsenceNotificationId）
3. 論理削除による履歴保持（IsActive）

**バリデーション**
- AttendanceDate: 必須、有効な日付形式
- Status: 'blank', 'present', 'absent', 'late' のみ許可
- ArrivalTime: ステータスが'present'または'late'の場合のみ設定可能

## 8. 非機能要件

### 8.1 パフォーマンス
- 出欠表の初期表示: 2秒以内
- ステータス更新のレスポンス: 1秒以内
- 一括出席処理: 3秒以内（30名まで）

### 8.2 セキュリティ
- スタッフ認証必須
- 担当クラスの園児のみ表示・更新可能
- 他クラスの出欠記録へのアクセス制限

### 8.3 可用性
- ネットワーク切断時: オフライン表示（読み取り専用）
- サーバーエラー時: エラーメッセージ表示
- データ同期: 再接続時に自動同期

## 9. 今後の拡張性

### 9.1 統計機能
- 月次出席率の表示
- 個別園児の出席傾向分析
- クラス全体の出欠統計

### 9.2 通知機能
- 未記録の園児がいる場合のリマインダー
- 欠席が多い園児への注意喚起
- 保護者への出席確認通知

### 9.3 エクスポート機能
- 出欠記録のCSVエクスポート
- 月次レポートのPDF生成
- 統計データのグラフ表示

## 10. 画面遷移

```
スタッフダッシュボード
  ↓
出欠表画面
  ├→ 日付変更（前日/翌日）
  ├→ ステータス変更モーダル
  │   └→ 保存 → 出欠表更新
  └→ 一括出席確認ダイアログ
      └→ OK → 一括更新 → 出欠表更新

連絡確認画面
  ↓
「確認」ボタンクリック
  ↓
バックエンド処理（AbsenceNotification更新 + DailyAttendance作成）
  ↓
出欠表に自動反映（リアルタイム更新）
```

## 11. エラーハンドリング

### 11.1 エラーシナリオ

| エラー | 原因 | 対処 |
|-------|------|------|
| 重複記録エラー | 同一園児・同一日の記録が既存 | 既存記録を更新 |
| 権限エラー | 担当外クラスへのアクセス | エラーメッセージ表示 |
| ネットワークエラー | 接続切断 | オフライン表示 + 再試行 |
| バリデーションエラー | 不正なステータス値 | エラーメッセージ + 再入力 |

### 11.2 ユーザーメッセージ

**成功メッセージ**
- 「出欠記録を更新しました」
- 「15名の園児を出席にしました」

**エラーメッセージ**
- 「出欠記録の更新に失敗しました。もう一度お試しください」
- 「ネットワークエラーが発生しました。接続を確認してください」
- 「この操作を行う権限がありません」

## 12. 実装の優先順位

### Phase 1: 基本機能（MVP）
1. DailyAttendancesテーブル作成
2. 出欠表画面の実装（表示のみ）
3. 手動ステータス変更機能
4. 日付スライド機能

### Phase 2: 連携機能
1. 連絡確認画面との自動連携
2. AbsenceNotificationからの自動記録作成
3. 一括出席機能

### Phase 3: 拡張機能
1. 出欠統計表示
2. エクスポート機能
3. 通知機能

## 13. テストシナリオ

### 13.1 基本操作テスト
- [ ] 出欠表が正しく表示される
- [ ] 日付を変更できる
- [ ] ステータスをタップで切り替えできる（空白→出席→欠席→遅刻→空白）
- [ ] 変更が保存される
- [ ] 📧連絡アイコンが欠席・遅刻連絡がある園児のみ表示される
- [ ] 📝備考アイコンが備考がある園児のみ表示される
- [ ] 連絡アイコンをタップすると連絡内容がモーダル表示される
- [ ] 備考アイコンをタップすると備考入力モーダルが表示される
- [ ] 備考を保存すると📝アイコンが表示される

### 13.2 連携テスト
- [ ] 欠席連絡を確認すると出欠表に「欠席」が表示される
- [ ] 遅刻連絡を確認すると出欠表に「遅刻」が表示される
- [ ] 手動変更が優先される

### 13.3 一括操作テスト
- [ ] 空白の園児のみが一括出席の対象になる
- [ ] 確認ダイアログが表示される
- [ ] 一括出席が正常に実行される

### 13.4 エッジケーステスト
- [ ] 同じ園児の同じ日の記録が複数作成されない
- [ ] 過去の日付の記録を変更できる
- [ ] 未来の日付の記録を作成できる
- [ ] 担当外クラスへのアクセスが拒否される

---

## 承認

**作成日**: 2025-11-14
**作成者**: Claude Code
**レビュー**: 待機中
**承認**: 待機中
