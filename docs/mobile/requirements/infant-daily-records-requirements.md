# 生活記録機能 要件定義書

## 1. 概要

### 1.1 目的
0～2歳児を対象とした生活記録機能を提供する。保護者が朝の様子（体温・子供の様子）を入力し、保育士が園での記録（食事、睡眠、排泄、機嫌など）を効率的に入力し、保護者がそれを確認できる双方向の連絡機能を実現する。

**重要**:
- 保護者は朝の体温と子供の様子（フリーフォーマット）のみを入力（シンプル）
- 保育士は園での詳細な記録を入力
- 個別の自由記述連絡事項は年齢に関わらず既存の `DailyReports` 機能を使用します。

### 1.2 対象ユーザー

#### 保育士
- 0～2歳児クラスの担当保育士
- 役割: 園での記録入力・確認、保護者からの申し送り確認

#### 保護者
- 0～2歳児の保護者
- 役割:
  - **朝の入力**: 登園前に体温と子供の様子を入力
  - **閲覧**: 園での記録を確認（降園後）

### 1.3 対象年齢層
- 0歳児クラス（保育士1人あたり園児3人）
- 1～2歳児クラス（保育士1人あたり園児6人）

### 1.4 背景
- 0～2歳児は発達段階が未熟で、日々の体調管理が重要
- 保護者は朝の家庭での様子を保育士に伝える必要がある
- 保育士は園での様子を詳しく記録し、保護者に共有する必要がある
- 保育士は日々の記録が法的義務ではないが、保護者との信頼関係構築・SIDS予防の観点から重要
- 一人当たりの園児数が少なく、個別記録が現実的に可能

---

## 2. 機能要件

### 2.1 記録項目

#### 2.1.1 体温（Temperature）
**保護者が入力（朝）**:
- **朝の体温**: 登園前に自宅で測定
  - 測定時刻（自動記録）
  - 体温値（℃）
  - 入力UI: 電卓形式（スタッフと同じUI）

**保育士が入力（園）**:
- **午前の体温**: 保育士が記録（保護者入力値の確認・修正も可能）
  - 測定時刻
  - 体温値（℃）
- **午後の体温**: 保育士が記録
  - 測定時刻
  - 体温値（℃）

**フェーズ2予定**:
- 異常フラグの自動判定機能（37.5℃以上）

#### 2.1.2 保護者からの申し送り（ParentMorningNote）
**保護者が入力（朝）**:
- **子供の様子**: フリーフォーマットのテキスト入力
  - 朝食の食べ具合
  - 夜の睡眠状況
  - 体調・機嫌
  - 保育士への申し送り事項（薬、持ち物、注意点など）
  - 入力UI: 複数行のテキストエリア

**保育士が閲覧**:
- 登園時に保護者からの申し送りを確認
- 記録画面で参照可能

#### 2.1.3 食事（Meals）
**保育士が入力（園）**:
- **午前おやつ**: 保護者からの申し送りを参考に記録
  - 摂取量（完食、ほとんど、半分、少し、なし）
- **昼食**: 保育士が記録
  - 摂取量（完食、ほとんど、半分、少し、なし）
- **おやつ**: 保育士が記録
  - 摂取量（完食、ほとんど、半分、少し、なし）

#### 2.1.4 睡眠（Sleep）
**保育士が入力（園）**:
- **昼寝（午睡）**: 園での記録
  - 開始時刻
  - 終了時刻
  - 睡眠時間（自動計算）

**フェーズ2予定**:
- 睡眠の質（ぐっすり、普通、浅い、何度も起きた）
- 備考（寝つきの様子、起き方など）
- 午睡チェック（SIDS予防）: 5～10分間隔での呼吸確認、体位記録

#### 2.1.5 排泄（Toileting）
**保育士が入力（園）**:
**実装方式**: 排泄ごとに1レコード作成（時刻ベースの記録）

- **おしっこ（尿）**:
  - 排泄時刻
  - おしっこの量（少量/普通/多量）
  - おむつ交換回数

- **うんち（便）**:
  - 排泄時刻
  - 便の状態（普通/硬い/軟便/下痢）
  - 便の色（通常/緑色/白色/黒色/血便）
  - おむつ交換回数

**備考**:
- 各排泄は個別のレコードとして記録
- 1日の排泄回数は記録数から自動集計

#### 2.1.6 機嫌（Mood）
**保育士が入力（園）**:
- **午前の機嫌（登園時）**:
  - 状態（良い/普通/悪い/泣いていた）
- **午後の機嫌（降園前）**:
  - 状態（良い/普通/悪い/泣いていた）

**フェーズ2予定**:
- 備考（登園時・降園時の詳細な様子）

#### 2.1.7 その他の記録
以下は別機能で管理:
- **活動内容**: `DailyReports` 機能で記録
- **保護者への詳細連絡事項**: `DailyReports` 機能で記録

---

### 2.2 保育士向け機能（入力・管理）

#### 2.2.1 基本操作要件（実装済み）
- **ワンハンド操作対応**: 赤ちゃんを抱っこしながら片手で操作可能
- **大きなタッチターゲット**: 最小44pt/48px
- **テキスト入力の最小化**: ボタン・アイコンで選択できる形式
- **フッター固定保存ボタン**: 画面下部に常時表示（親指操作可能）
- **日付切り替え**: 前後ボタンで日付を変更可能
- **保護者申し送り確認**: 登園時に保護者が入力した体温と様子を確認

**フェーズ2予定**:
- 一括入力機能（複数の園児に同じアクションを一括適用）
- デフォルト値アプローチ（「全員完食」から始めて例外を調整）
- オートセーブ（ローカルストレージで自動保存）

#### 2.2.2 画面構成

1. **生活記録一覧画面** (`/staff/infant-records`)
   - 日付選択（前後ボタン）
   - クラス情報（StaffClassContextから自動取得）
   - 園児一覧（カード形式）
   - 各園児の記録済みアイコン表示
   - 保護者からの申し送りバッジ表示
   - 「新規記録」ボタン

2. **生活記録入力画面** (`/staff/infant-records/create`)
   - ヘッダー（戻るボタン、タイトル「生活記録」、日付切り替え）
   - 保護者申し送り確認エリア（朝の体温、子供の様子）
   - 記録タイプ選択（5つのアイコンボタン）
     - 体温 / 食事 / 睡眠 / 排泄 / 機嫌
   - 測定タイミング選択（体温・機嫌: 午前/午後）
   - 園児選択ボタン（複数選択可能、排泄のみ単一選択）
   - 記録内容入力フォーム
   - 保存ボタン（フッター固定）
   - トースト通知（保存完了メッセージ）

**フェーズ2予定**:
- 一括入力画面
- 午睡チェック画面

#### 2.2.3 業務フロー
1. **朝の受け入れ時**
   - 保護者からの申し送り確認（体温、子供の様子）
   - 必要に応じて午前の体温・午前おやつ・機嫌を追記

2. **日中の活動時**
   - 食事後に昼食・おやつ記録
   - 排泄があった都度記録（時刻・状態）
   - 昼寝時に開始・終了時刻を記録

3. **降園前**
   - 午後の体温・機嫌を記録
   - 記録完了確認（未記入項目チェック）

---

### 2.3 保護者向け機能

#### 2.3.1 朝の入力機能（登園前）

**実装対象 - フェーズ2で実装予定**

1. **朝の体温入力画面** (`/parent/morning-input`)
   - 日付表示（当日のみ）
   - 子供の名前・写真
   - **体温入力**:
     - 電卓UI（スタッフと同じ）
     - 数値ボタン（0-9）
     - 小数点ボタン
     - クリアボタン
     - 入力値表示（大きく表示）
   - **子供の様子入力**:
     - 複数行テキストエリア
     - プレースホルダー: 「朝食の食べ具合、睡眠状況、体調、保育士への申し送りなどを入力してください」
     - 200文字程度を想定
   - 保存ボタン（フッター固定）
   - トースト通知（保存完了メッセージ）

**入力期限**:
- 登園前〜登園直後（当日の午前中）まで入力可能
- 当日中は編集可能
- 翌日以降は閲覧のみ

**UI/UX要件**:
- シンプル: 入力項目は体温と様子のみ
- スマホ最適化: 片手操作可能
- 大きなボタン: 高齢者（祖父母）も操作しやすい

#### 2.3.2 閲覧機能（降園後）

**実装対象 - フェーズ2で実装予定**

1. **生活記録タイムライン画面** (`/parent/daily-records`)
   - 日付選択（カレンダー、前後ボタン）
   - 子供の名前・写真
   - **タイムライン表示**（時系列）:
     - 朝の記録（保護者入力）
       - 体温
       - 子供の様子
     - 午前の記録（保育士入力）
       - 体温
       - 機嫌
     - 昼の記録（保育士入力）
       - 昼食
       - 昼寝（開始・終了時刻、睡眠時間）
     - 午後の記録（保育士入力）
       - おやつ
       - 体温
       - 機嫌
     - 排泄記録（保育士入力）
       - 時刻ごとの記録
       - おしっこ/うんちのアイコン表示
       - 状態・色の情報
   - アイコン・カード形式で視覚的に表示

2. **過去記録閲覧**
   - カレンダーで日付選択
   - 過去1年間の記録を閲覧可能（園の方針により設定）

**フェーズ2以降の拡張**:
- **項目別グラフ表示**:
  - 体温グラフ（週間/月間推移）
  - 食事記録（摂取量の推移）
  - 睡眠記録（昼寝時間の推移）
  - 排泄記録（回数・状態の推移）

#### 2.3.3 通知機能

**実装対象 - フェーズ2で実装予定**

1. **記録完了通知**
   - 保育士が当日の記録を完了したらプッシュ通知
   - 通知タイミング: 降園時間前（例: 16:00）

2. **体調異常通知**
   - 体温37.5℃以上: 即時プッシュ通知
   - 下痢が3回以上: プッシュ通知
   - その他異常時: 保育士が判断して通知

#### 2.3.4 閲覧権限
- 自分の子どもの記録のみ閲覧可能
- 過去の記録は園の方針に応じて閲覧期限設定（1年間など）

---

## 3. 非機能要件

### 3.1 パフォーマンス
- 画面表示: 2秒以内
- 記録保存: 1秒以内

### 3.2 可用性
- 稼働率: 99.5%以上（園の開園時間中）

**フェーズ2予定**:
- オフライン対応: ローカルストレージで一時保存、オンライン復帰時に自動同期

### 3.3 セキュリティ
- 個人情報保護: 園児の体調情報は機微情報として扱う
- アクセス制御:
  - 保育士: 担当クラスの園児のみ記録・閲覧可能
  - 保護者: 自分の子どものみ入力・閲覧可能
- 通信暗号化: HTTPS必須

### 3.4 ユーザビリティ

#### 保育士向け
- レスポンシブデザイン: スマートフォン・タブレット対応
- 片手操作: 親指での操作を前提とした配置
- アクセシビリティ: WCAG 2.1 AA準拠

#### 保護者向け
- シンプルなUI: 高齢者（祖父母）も操作しやすい
- 大きな文字・ボタン: 視認性・操作性の向上
- 直感的な操作: アイコンと短い説明

### 3.5 保守性
- ログ記録: 記録の作成・更新・削除のログ保存
- バックアップ: 日次バックアップ

---

## 4. ビジネスルール

### 4.1 記録の必須化
- 0～2歳児クラスの園児は**毎日全員**記録推奨
- 欠席日は記録不要（欠席フラグで管理）

### 4.2 保護者の入力期限
- **朝の体温・様子**: 登園前〜登園直後（当日午前中）まで入力可能
- **編集**: 当日中は編集可能
- **閲覧**: 翌日以降は閲覧のみ

### 4.3 保育士の編集
- 記録は保育士が編集可能
- 保護者が入力した朝の体温も保育士が確認・修正可能
- 削除は原則禁止（誤入力は修正履歴を残して訂正）

**フェーズ2予定**:
- 当日中のみ編集可能とする制限
- 翌日以降は閲覧のみ（修正が必要な場合は管理者権限で対応）

### 4.4 データの共有
- 保護者が入力した朝の体温は `InfantTemperature` テーブルに保存
  - `MeasurementType = 'Morning'`
  - `CreatedBy` には保護者のParentIdを記録
- 保育士はこのデータを閲覧・編集可能
- 保護者からの申し送りは保育士に表示される

### 4.5 午睡チェックの義務化
**フェーズ2で実装予定**:
- 昼寝中の園児は**5～10分間隔**で呼吸・体位チェック必須
- チェック漏れがある場合はアラート表示

### 4.6 保護者への公開タイミング
**フェーズ2で実装予定**:
- 記録完了後、自動的に保護者に公開
- 通知機能で保護者に通知

### 4.7 異常値の通知
**フェーズ2で実装予定**:
- 体温37.5℃以上: 保護者に即時通知
- 下痢が3回以上: 保護者に通知
- 食事摂取量が2食連続で「少し」以下: 園長・主任に通知

---

## 5. 制約事項

### 5.1 既存システムとの連携
- 既存の園児マスタ（Children）、クラスマスタ（Classes）、保育士マスタ（Staff）、保護者マスタ（Parents）を利用
- 既存の認証・認可システム（JWT、SMS認証）を利用
- StaffClassContext（フロントエンド）でクラス情報を管理

### 5.2 対象年齢層の限定
- **0～2歳児のみ**が対象
- 3～5歳児は別途「連絡帳機能（幼児向け）」で対応予定（本要件の対象外）

### 5.3 データベース反映
- テーブルレイアウトは設計後、ユーザー側でAzure SQL Databaseに反映
- マイグレーションは手動実行

---

## 6. データベース設計の重要事項

### 6.1 排泄記録（InfantToileting）の設計
**実装方式**: 排泄ごとに1レコード作成

- **主キー構成**: NurseryId, ChildId, RecordDate, ToiletingTime
- **排泄タイプ**: Urine（おしっこ）/ Bowel（うんち）
- **記録単位**: 1回の排泄ごとに1レコード
- **回数集計**: 同一日の RecordDate でレコード数をカウント

この設計により:
- 排泄の時刻を正確に記録可能
- 各排泄の詳細情報（量、状態、色）を個別管理
- 1日の排泄回数は動的に集計

### 6.2 保護者からの申し送り（ParentMorningNote）

**新規テーブル設計案**:

| カラム名 | 型 | 説明 |
|---------|-----|------|
| NurseryId | int | 保育園ID（主キー1） |
| ChildId | int | 園児ID（主キー2） |
| RecordDate | date | 記録日（主キー3） |
| Note | nvarchar(500) | 子供の様子（フリーフォーマット） |
| CreatedAt | datetime2 | 作成日時 |
| CreatedBy | int | 作成者ID（ParentId） |
| UpdatedAt | datetime2 | 更新日時 |
| UpdatedBy | int | 更新者ID |

**または既存DailyReportsの拡張**:
- ParentMorningNote フィールドを追加
- 保護者が入力、保育士が閲覧

### 6.3 体温記録の保護者入力対応

**InfantTemperature テーブルの拡張**:
- `CreatedBy` フィールドで保育士（StaffId）または保護者（ParentId）を識別
- 保護者が入力した朝の体温は `MeasurementType = 'Morning'`
- 保育士は保護者入力値を確認・編集可能

---

## 7. 今後の拡張予定

### 7.1 フェーズ2（次期実装）

#### 保護者向け機能（優先度高）
- **朝の入力機能**: 体温入力（電卓UI）、子供の様子入力（テキストエリア）
- **閲覧機能**: タイムライン表示、カード形式表示
- **通知機能**: 記録完了通知、体調異常通知

#### 保育士向け機能
- **一括入力機能**: 複数の園児に同じアクションを一括適用
- **デフォルト値アプローチ**: 「全員完食」など最も多いパターンを初期値とし、例外のみ修正
- **オートセーブ機能**: ローカルストレージで自動保存、保育中の中断対策
- **午睡チェック機能**: SIDS予防のための5～10分間隔チェック
  - タイマー機能（5分/10分間隔アラート）
  - チェック項目（呼吸/体位/異常）
  - クイック入力（全員OK、個別異常入力）
- **記録の編集制限**: 当日中のみ編集可能、翌日以降は閲覧のみ
- **下書き保存機能**: 記録の一時保存

#### 記録項目の拡張
- **体温**: 異常フラグの自動判定（37.5℃以上）
- **睡眠**: 睡眠の質、備考フィールド
- **機嫌**: 備考フィールド

#### その他
- **オフライン対応**: ローカルストレージで一時保存、オンライン復帰時に自動同期

### 7.2 フェーズ3以降（検討中）
- **項目別グラフ表示**: 体温・食事・睡眠の推移グラフ（保護者向け）
- **写真添付機能**: 活動の様子を写真で共有
- **AIによる体調異常の早期検知**: 体温・食事・排泄パターン分析
- **3～5歳児向け連絡帳機能**: 必要な園児のみ記録
- **保護者からのフィードバック機能**: コメント、既読確認

### 7.3 運用後の改善
- 保育士・保護者からのフィードバックを基にUI/UX改善
- 入力項目の追加・削除（園の要望に応じて柔軟に対応）

---

## 8. 参考資料

### 8.1 関連要件定義書
- [authentication-requirements.md](authentication-requirements.md)
- [multi-class-staff-requirements.md](multi-class-staff-requirements.md)
- [attendance-sheet-requirements.md](attendance-sheet-requirements.md)

### 8.2 関連仕様書
- [infant-daily-records-ui-spec.md](../specifications/infant-daily-records-ui-spec.md)
- [staff-class-context-frontend-spec.md](../specifications/staff-class-context-frontend-spec.md)
- [authentication-technical-spec.md](../specifications/authentication-technical-spec.md)

### 8.3 データベース設計
- [infant-daily-records-schema.md](../database/infant-daily-records-schema.md)

### 8.4 既存テーブル
- Children（園児マスタ）
- Classes（クラスマスタ）
- Staff（保育士マスタ）
- Parents（保護者マスタ）

---

## 9. 用語集

| 用語 | 説明 |
|------|------|
| 生活記録 | 保育園での0～2歳児の日々の生活（体温、食事、睡眠、排泄、機嫌）を記録する機能 |
| 連絡帳 | 保育園と保護者間で日々の情報を共有するノート（本機能ではデジタル化） |
| 申し送り | 保護者から保育士への朝の子供の様子や注意事項の伝達 |
| 午睡チェック | 昼寝中の園児の呼吸・体位を定期的に確認する安全管理業務（フェーズ2実装予定） |
| SIDS | 乳幼児突然死症候群（Sudden Infant Death Syndrome）の略。午睡チェックで予防 |
| 乳児 | 0歳児クラスの園児 |
| 幼児 | 1～5歳児クラスの園児（本要件では1～2歳児が対象） |
| ワンハンド操作 | 片手（親指）だけで操作できるUI設計 |
| デフォルト値アプローチ | 「全員完食」など最も多いパターンを初期値とし、例外のみ修正する入力方式（フェーズ2実装予定） |
| トースト通知 | 画面下部にフワッと表示される一時的なメッセージ通知 |
| 電卓UI | 数値入力用の電卓風インターフェース（0-9ボタン、小数点、クリアボタン） |

---

## 10. 実装状況サマリー

### 実装済み（フェーズ1: 保育士向け）
✅ 生活記録一覧画面
✅ 生活記録入力画面
✅ 体温記録（午前/午後）
✅ 食事記録（午前おやつ/昼食/午後おやつ）
✅ 睡眠記録（開始/終了時刻、自動計算）
✅ 排泄記録（時刻ベース、おしっこ/うんち、詳細情報）
✅ 機嫌記録（午前/午後）
✅ ワンハンド操作対応UI
✅ 大きなタッチターゲット
✅ フッター固定保存ボタン
✅ トースト通知
✅ 日付切り替え機能

### 実装予定（フェーズ2: 保護者向け + 拡張）

#### 保護者向け機能
⏳ 朝の体温入力（電卓UI）
⏳ 子供の様子入力（フリーフォーマット）
⏳ 記録の閲覧（タイムライン表示）
⏳ 通知機能（記録完了、体調異常）
⏳ カレンダーで過去記録閲覧

#### 保育士向け拡張
⏳ 保護者申し送り確認機能
⏳ 一括入力機能
⏳ オートセーブ機能
⏳ 午睡チェック機能
⏳ 異常値の自動判定・通知
⏳ 記録の編集制限（当日のみ）
⏳ 睡眠の質・備考フィールド
⏳ 機嫌の備考フィールド

### 実装予定（フェーズ3以降）
⏳ グラフ表示機能（体温・食事・睡眠の推移）
⏳ オフライン対応
⏳ 写真添付機能
⏳ AI体調異常検知
