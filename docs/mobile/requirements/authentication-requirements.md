# SMS認証システム要件定義書

## 1. 概要

保育園管理システムにおけるSMS認証ベースのログインシステム。
保護者・スタッフ・保護者兼スタッフの複数役割に対応した認証フローを提供する。

## 2. ユーザー役割定義

### 2.1 保護者ユーザー
- **定義**: 園児の保護者として登録されているユーザー
- **条件**:
  - Parentsテーブルに電話番号が登録されている
  - かつ、ParentRelationshipsテーブルで園児と関連付けられている
- **アクセス権限**: 保護者ポータル

### 2.2 スタッフユーザー
- **定義**: 保育園の職員として登録されているユーザー
- **条件**: Staffテーブルに電話番号が登録されている
- **アクセス権限**: スタッフポータル

### 2.3 保護者兼スタッフユーザー
- **定義**: 保護者でありながら同時に保育園職員でもあるユーザー
- **条件**:
  - Parentsテーブルに電話番号が登録されている
  - かつ、ParentRelationshipsテーブルで園児と関連付けられている
  - かつ、Staffテーブルにも同じ電話番号が登録されている
- **アクセス権限**: 保護者ポータル・スタッフポータル両方（ユーザー選択可能）

## 3. 認証フロー要件

### 3.1 Step 1: 電話番号入力・事前チェック

#### 3.1.1 電話番号バリデーション
- **形式**: 日本の携帯電話番号（070/080/090）
- **桁数**: 11桁（ハイフンなし）
- **例**: 09012345678

#### 3.1.2 ユーザー存在チェック
電話番号入力後、以下の順序でデータベースを確認：

1. **保護者確認クエリ**:
   ```sql
   SELECT p.*, pr.ChildId
   FROM Parents p
   INNER JOIN ParentRelationships pr ON p.Id = pr.ParentId
   WHERE p.PhoneNumber = @phoneNumber AND p.IsActive = 1
   ```

2. **スタッフ確認クエリ**:
   ```sql
   SELECT s.*
   FROM Staff s
   WHERE s.PhoneNumber = @phoneNumber AND s.IsActive = 1
   ```

#### 3.1.3 ユーザー分類結果
| 保護者データ | スタッフデータ | 結果 | 次のアクション |
|-------------|-------------|------|---------------|
| あり | なし | 保護者 | SMS送信 → 保護者ポータル |
| なし | あり | スタッフ | SMS送信 → スタッフポータル |
| あり | あり | 保護者兼スタッフ | SMS送信 → 役割選択画面 |
| なし | なし | 未登録 | エラー表示・アクセス拒否 |

### 3.2 Step 2: SMS認証コード送信

#### 3.2.1 送信条件
- Step 1で有効なユーザーと判定された場合のみ送信
- Media4U SMS APIを使用
- 開発環境では実際の送信を無効化、ログ出力のみ

#### 3.2.2 認証コード仕様
- **桁数**: 6桁数字
- **有効期限**: 5分間
- **ハッシュ化**: BCryptによる暗号化保存
- **再送制限**: 1分間のクールダウン
- **日次制限**: 1日あたり3回まで

### 3.3 Step 3: SMS認証コード検証

#### 3.3.1 検証ロジック
1. 認証コードの照合（BCrypt検証）
2. 有効期限チェック
3. 使用済みフラグチェック
4. 試行回数制限（5分間に3回まで）

#### 3.3.2 認証成功後の処理
1. SMS認証レコードを使用済みにマーク
2. 最終ログイン時刻を更新
3. JWTアクセストークン生成（有効期限: 1時間）
4. リフレッシュトークン生成（有効期限: 7日）
5. 適切なポータルまたは選択画面にリダイレクト

## 4. ポータル誘導要件

### 4.1 保護者のみの場合
- **直接誘導**: 保護者ダッシュボード
- **URL**: `/dashboard/parent`
- **機能**: 欠席連絡、写真閲覧、レポート確認等

### 4.2 スタッフのみの場合
- **直接誘導**: スタッフダッシュボード
- **URL**: `/dashboard/staff`
- **機能**: 園児管理、レポート作成、写真アップロード等

### 4.3 保護者兼スタッフの場合
- **中間画面**: 役割選択画面を表示
- **URL**: `/role-selection`
- **選択肢**:
  - 「保護者として利用」→ `/dashboard/parent`
  - 「スタッフとして利用」→ `/dashboard/staff`
- **記憶機能**: 前回選択した役割をローカルストレージに保存

## 5. セキュリティ要件

### 5.1 レート制限
- **SMS送信**: 1日3回まで、1分間のクールダウン
- **認証試行**: 5分間に3回まで
- **IP単位制限**: 同一IPから1時間に10回まで

### 5.2 トークン管理
- **アクセストークン**: JWT形式、1時間有効
- **リフレッシュトークン**: ランダム文字列、7日間有効
- **自動更新**: アクセストークン期限前の自動リフレッシュ

### 5.3 ログ記録
- **認証成功/失敗**: 全ての認証試行をログ出力
- **IP追跡**: 不正アクセス検知のためのIP記録
- **セッション管理**: アクティブセッション追跡

## 6. エラーハンドリング要件

### 6.1 ユーザー向けエラーメッセージ
| エラーケース | メッセージ |
|-------------|-----------|
| 未登録電話番号 | 「この電話番号は登録されていません。園にお問い合わせください。」 |
| SMS送信制限 | 「本日のSMS送信回数の上限に達しました。明日再試行してください。」 |
| 認証コード間違い | 「認証コードが正しくありません。」 |
| 認証コード期限切れ | 「認証コードの有効期限が切れています。新しいコードを取得してください。」 |
| 認証試行制限 | 「認証試行回数が上限に達しました。5分後に再試行してください。」 |

### 6.2 システムエラー対応
- **Media4U API障害**: フォールバック機能（メール通知等）
- **データベース障害**: 適切なエラーレスポンス
- **ネットワーク障害**: リトライ機能

## 7. UI/UX要件

### 7.1 レスポンシブデザイン
- **スマートフォン最適化**: 主要ターゲットデバイス
- **タブレット対応**: iPad等での利用可能
- **デスクトップ対応**: 管理者用途

### 7.2 アクセシビリティ
- **WCAG 2.1 AA準拠**: 基本的なアクセシビリティ対応
- **キーボードナビゲーション**: 全機能をキーボードで操作可能
- **スクリーンリーダー対応**: 適切なARIA属性設定

### 7.3 ユーザビリティ
- **電話番号自動フォーマット**: ハイフン自動挿入
- **認証コード入力**: 6桁の数字入力欄
- **エラー表示**: 明確で分かりやすいエラーメッセージ
- **ローディング表示**: 処理中の視覚的フィードバック

## 8. データモデル要件

### 8.1 関連テーブル
- **Parents**: 保護者情報
- **ParentRelationships**: 保護者-園児関連
- **Staff**: スタッフ情報
- **SmsAuthentications**: SMS認証履歴
- **RefreshTokens**: リフレッシュトークン管理

### 8.2 新規追加カラム
- **Parents.LastLoginAt**: 最終ログイン時刻
- **Staff.LastLoginAt**: 最終ログイン時刻
- **UserSessions**: セッション管理（新規テーブル）

## 9. パフォーマンス要件

### 9.1 レスポンス時間
- **電話番号チェック**: 500ms以内
- **SMS送信**: 3秒以内
- **認証検証**: 1秒以内

### 9.2 スケーラビリティ
- **同時接続数**: 100セッション
- **データベース**: インデックス最適化
- **キャッシュ**: レスポンス向上のためのメモリキャッシュ

## 10. 運用要件

### 10.1 監視
- **認証成功率**: 監視ダッシュボード
- **SMS送信状況**: Media4U API状態監視
- **エラー率**: 異常検知アラート

### 10.2 メンテナンス
- **ログローテーション**: 30日間保持
- **期限切れトークン**: 自動削除バッチ処理
- **統計レポート**: 月次利用状況レポート