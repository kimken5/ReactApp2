# スタッフお知らせ管理機能 要件定義書

## 1. 概要

スタッフがダッシュボードから自分が作成したお知らせの一覧を確認し、新規作成・編集・削除を行える機能を提供する。レポート管理機能と同様のUX/UIパターンを採用し、一貫性のある操作性を実現する。

## 2. 目的

- スタッフが作成したお知らせを一元管理できるようにする
- お知らせの作成・編集・削除を効率的に行えるようにする
- 保護者向けお知らせの品質と一貫性を担保する
- レポート管理と同様の操作感で学習コストを削減する

## 3. 機能要件

### 3.1 お知らせ一覧表示機能

#### 3.1.1 基本機能
- スタッフダッシュボードからお知らせ一覧画面に遷移できる
- 自分（ログイン中のスタッフ）が作成したお知らせのみを表示する
- お知らせは作成日時の降順で表示する（最新が一番上）

#### 3.1.2 表示項目
各お知らせカードには以下の情報を表示する：
- **タイトル**：お知らせのタイトル
- **内容プレビュー**：本文の最初の100文字程度
- **カテゴリ**：お知らせのカテゴリ（一般、緊急、イベント、健康、献立など）
- **対象範囲**：全体、クラス単位、個別など
- **公開状態**：下書き、公開済み、アーカイブ
- **公開日時**：公開された日時（公開済みの場合）
- **作成日時**：お知らせを作成した日時
- **更新日時**：最終更新日時

#### 3.1.3 ステータス表示
- **下書き**：黄色のバッジ（編集・削除可能）
- **公開済み**：緑色のバッジ（編集・アーカイブ可能）
- **アーカイブ**：グレーのバッジ（閲覧のみ）

#### 3.1.4 フィルタリング・検索機能
- **ステータスフィルタ**：下書き、公開済み、アーカイブで絞り込み
- **カテゴリフィルタ**：カテゴリ別に絞り込み
- **対象範囲フィルタ**：全体、クラス単位、個別で絞り込み
- **キーワード検索**：タイトルと本文から部分一致検索

### 3.2 お知らせ新規作成機能

#### 3.2.1 入力項目
- **タイトル**（必須）：最大100文字
- **カテゴリ**（必須）：プルダウンから選択
  - 一般
  - 緊急
  - イベント
  - 健康
  - 献立
  - 持ち物
  - その他
- **対象範囲**（必須）：
  - 全体：全保護者
  - クラス単位：特定のクラスの保護者のみ
  - 個別：特定の園児の保護者のみ
- **対象クラス**：対象範囲が「クラス単位」の場合のみ選択（複数選択可）
- **対象園児**：対象範囲が「個別」の場合のみ選択（複数選択可）
- **本文**（必須）：マークダウン対応、最大5000文字
- **添付ファイル**（任意）：画像・PDF（最大5ファイル、各10MB以内）
- **公開日時**（任意）：指定した日時に自動公開（未指定の場合は即時公開）
- **重要度**：通常、重要、緊急の3段階
- **コメント許可**：保護者からのコメントを許可するか

#### 3.2.2 保存オプション
- **下書き保存**：公開せずに保存（後で編集可能）
- **プレビュー**：保護者側の表示を確認
- **公開**：即座に公開（または指定日時に予約公開）

#### 3.2.3 バリデーション
- 必須項目の入力チェック
- 文字数制限チェック
- ファイルサイズ・形式チェック
- 対象範囲に応じた対象選択チェック

### 3.3 お知らせ編集機能

#### 3.3.1 編集可能条件
- **下書き**：全項目編集可能、削除可能
- **公開済み**：タイトル、本文、添付ファイルのみ編集可能
  - カテゴリ、対象範囲は変更不可（混乱防止のため）
  - 編集後は「更新日時」を記録
- **アーカイブ**：編集不可（閲覧のみ）

#### 3.3.2 編集画面
- 新規作成画面と同じレイアウト
- 公開済みの場合、変更不可項目はグレーアウト表示
- 編集履歴を保持（更新日時、更新者を記録）

#### 3.3.3 保存オプション
- **下書き保存**：下書き状態の場合のみ
- **更新して公開**：公開済みの場合
- **アーカイブ**：公開済みの場合のみ（アーカイブに移動）

### 3.4 お知らせ削除機能

#### 3.4.1 削除可能条件
- **下書きのみ削除可能**
- 公開済み・アーカイブは削除不可（履歴保持のため）
- 削除前に確認ダイアログを表示

#### 3.4.2 削除確認
- 「このお知らせを削除しますか？」メッセージ
- タイトルを表示して誤削除を防止
- 「この操作は取り消せません」警告表示

### 3.5 お知らせ詳細表示機能

#### 3.5.1 表示内容
- お知らせの全情報を表示
- 添付ファイルのプレビュー・ダウンロード
- 保護者からのコメント一覧（コメント許可時）
- 既読状況（何人の保護者が既読か）

#### 3.5.2 アクション
- 編集ボタン（編集可能な場合）
- アーカイブボタン（公開済みの場合）
- 削除ボタン（下書きの場合）
- 戻るボタン

## 4. 非機能要件

### 4.1 パフォーマンス
- お知らせ一覧の初期表示は2秒以内
- ページネーションまたは無限スクロールで大量データに対応
- 1ページあたり20件表示

### 4.2 ユーザビリティ
- レポート管理機能と同様のUI/UXパターンを採用
- レスポンシブデザイン（スマートフォン、タブレット対応）
- 操作結果のフィードバック（成功/失敗メッセージ）
- エラーメッセージは具体的で理解しやすい内容

### 4.3 セキュリティ
- 自分が作成したお知らせのみ表示・編集可能
- 他のスタッフのお知らせは表示・編集不可
- 管理者は全てのお知らせを閲覧・編集可能
- XSS対策（入力値のサニタイズ）
- CSRF対策（トークン検証）

### 4.4 データ整合性
- 公開済みお知らせは対象範囲の変更不可
- 削除は論理削除（物理削除は行わない）
- アーカイブ後も閲覧可能（履歴保持）

## 5. UI/UX要件

### 5.1 画面遷移
```
スタッフダッシュボード
  └─ お知らせ管理（お知らせ一覧）
       ├─ 新規作成 → お知らせ作成画面
       ├─ 編集 → お知らせ編集画面
       ├─ 詳細表示 → お知らせ詳細画面
       └─ 削除 → 確認ダイアログ → 一覧に戻る
```

### 5.2 レイアウト
- **一覧画面**：カード型レイアウト（レポート一覧と同様）
- **作成・編集画面**：フォーム型レイアウト（レポート作成と同様）
- **詳細画面**：読み取り専用のフォーム型レイアウト

### 5.3 カラーリング
- **下書き**：黄色系（#fef3c7背景、#f59e0bテキスト）
- **公開済み**：緑色系（#d1fae5背景、#10b981テキスト）
- **アーカイブ**：グレー系（#f1f5f9背景、#64748bテキスト）
- **緊急**：赤色系（#fee2e2背景、#ef4444テキスト）

### 5.4 アイコン
- **お知らせ一覧**：MdAnnouncement
- **新規作成**：MdAdd
- **編集**：MdEdit
- **削除**：MdDelete
- **公開**：MdSend
- **アーカイブ**：MdArchive
- **プレビュー**：MdVisibility

## 6. データモデル

### 6.1 Announcements テーブル
既存のAnnouncementsテーブルを使用（必要に応じてカラム追加）

### 6.2 主要フィールド
- **Id**：お知らせID（主キー）
- **NurseryId**：保育園ID
- **StaffId**：作成したスタッフのID
- **Title**：タイトル
- **Content**：本文
- **Category**：カテゴリ
- **TargetScope**：対象範囲（all/class/individual）
- **TargetClassIds**：対象クラスID（JSON配列）
- **TargetChildIds**：対象園児ID（JSON配列）
- **Attachments**：添付ファイル（JSON配列）
- **Status**：ステータス（draft/published/archived）
- **Priority**：重要度（normal/important/urgent）
- **AllowComments**：コメント許可フラグ
- **PublishedAt**：公開日時
- **ScheduledAt**：予約公開日時
- **CreatedAt**：作成日時
- **UpdatedAt**：更新日時
- **IsActive**：論理削除フラグ

## 7. API仕様（概要）

### 7.1 お知らせ一覧取得
- **エンドポイント**：`GET /api/Announcements/staff/my`
- **説明**：ログイン中のスタッフが作成したお知らせ一覧を取得
- **クエリパラメータ**：
  - `status`: ステータスフィルタ
  - `category`: カテゴリフィルタ
  - `page`: ページ番号
  - `pageSize`: 1ページあたりの件数

### 7.2 お知らせ詳細取得
- **エンドポイント**：`GET /api/Announcements/{id}`
- **説明**：指定したお知らせの詳細を取得

### 7.3 お知らせ作成
- **エンドポイント**：`POST /api/Announcements`
- **説明**：新しいお知らせを作成

### 7.4 お知らせ更新
- **エンドポイント**：`PUT /api/Announcements/{id}`
- **説明**：既存のお知らせを更新

### 7.5 お知らせ削除
- **エンドポイント**：`DELETE /api/Announcements/{id}`
- **説明**：お知らせを削除（下書きのみ）

### 7.6 お知らせ公開
- **エンドポイント**：`POST /api/Announcements/{id}/publish`
- **説明**：下書きを公開状態に変更

### 7.7 お知らせアーカイブ
- **エンドポイント**：`POST /api/Announcements/{id}/archive`
- **説明**：公開済みをアーカイブ状態に変更

## 8. 制約事項

### 8.1 データ制約
- タイトル：最大100文字
- 本文：最大5000文字
- 添付ファイル：最大5個、各10MB以内
- 対象クラス/園児：最大50個まで選択可能

### 8.2 操作制約
- 公開済みお知らせのカテゴリ・対象範囲は変更不可
- 下書きのみ削除可能
- アーカイブ後は閲覧のみ可能

### 8.3 権限制約
- 一般スタッフ：自分が作成したお知らせのみ操作可能
- 管理者：全てのお知らせを閲覧・編集可能

## 9. 今後の拡張予定

- お知らせテンプレート機能
- 既読確認詳細（誰が既読か）
- 保護者からのコメント管理
- お知らせの複製機能
- お知らせの一括操作（一括アーカイブなど）
- 通知設定（プッシュ通知、メール通知）
- お知らせの統計情報（既読率、コメント数など）

## 10. 参考

- レポート管理機能と同様のUI/UXパターンを踏襲
- 既存のAnnouncementsテーブル・AnnouncementsControllerを拡張
- 既存のUI コンポーネントを再利用して開発効率化
