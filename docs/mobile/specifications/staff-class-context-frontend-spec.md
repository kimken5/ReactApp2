# „Çπ„Çø„ÉÉ„Éï„ÇØ„É©„Çπ„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà - „Éï„É≠„É≥„Éà„Ç®„É≥„ÉâÊäÄË°ì‰ªïÊßòÊõ∏

## 1. Ê¶ÇË¶Å

### 1.1 ÁõÆÁöÑ
Ë§áÊï∞„ÇØ„É©„Çπ„ÇíÊãÖÂΩì„Åô„Çã„Çπ„Çø„ÉÉ„Éï„Åå„ÄÅÁèæÂú®‰ΩúÊ•≠‰∏≠„ÅÆ„ÇØ„É©„Çπ„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„ÇíÊòéÁ¢∫„Å´ÁÆ°ÁêÜ„Åó„ÄÅ„Çπ„É†„Éº„Ç∫„Å´„ÇØ„É©„Çπ„ÇíÂàá„ÇäÊõø„Åà„Çâ„Çå„Çã‰ªïÁµÑ„Åø„Çí„Éï„É≠„É≥„Éà„Ç®„É≥„Éâ„ÅßÂÆüË£Ö„Åó„Åæ„Åô„ÄÇ

### 1.2 ÂØæË±°ÁîªÈù¢
- „Çπ„Çø„ÉÉ„Éï„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ (`/staff/dashboard`)
- „É¨„Éù„Éº„Éà‰ΩúÊàêÁîªÈù¢ (`/staff/reports/create`)
- ÂÜôÁúüÁÆ°ÁêÜÁîªÈù¢ (`/staff/photos`)
- ÂÜôÁúü„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÁîªÈù¢ (`/staff/photos/upload`)
- „ÅäÁü•„Çâ„Åõ‰ΩúÊàêÁîªÈù¢ (`/staff/announcements/create`)
- ÈÄ£Áµ°Âèó‰ø°„ÉªÁ¢∫Ë™çÁîªÈù¢ (`/staff/contacts`)

## 2. ÂûãÂÆöÁæ©

### 2.1 Êó¢Â≠òÂûã„ÅÆÊã°Âºµ

#### `reactapp.client/src/types/auth.ts`

```typescript
// ClassAssignment„ÅÆÂûãÂÆöÁæ©„ÇíËøΩÂä†
export interface ClassAssignment {
  classId: string;
  className: string;
  assignmentRole: 'MainTeacher' | 'AssistantTeacher';
}

// AuthUser„Ç§„É≥„Çø„Éº„Éï„Çß„Éº„Çπ„ÅÆÊã°Âºµ
export interface AuthUser {
  id: string;
  phoneNumber: string;
  name?: string;
  role: 'Parent' | 'Staff';
  isVerified: boolean;
  createdAt: string;
  parent?: {
    id: string;
    name: string;
  } | null;
  staff?: {
    id: string;
    nurseryId: number;
    staffId: number;
    name: string;
    role: string;
    classAssignments: ClassAssignment[]; // ‚Üê ËøΩÂä†
  } | null;
}
```

### 2.2 Êñ∞Ë¶èÂûãÂÆöÁæ©

#### `reactapp.client/src/types/staffClass.ts`

```typescript
export interface ClassInfo {
  classId: string;
  className: string;
  assignmentRole: 'MainTeacher' | 'AssistantTeacher';
  nurseryId: number;
}

export interface StaffClassContextType {
  nurseryId: number;
  staffId: number;
  currentClass: ClassInfo | null;
  availableClasses: ClassInfo[];
  isMultiClass: boolean;
  isLoading: boolean;
  switchClass: (classId: string) => Promise<void>;
  refreshClasses: () => Promise<void>;
}

export interface ClassSelectorProps {
  currentClass: ClassInfo | null;
  availableClasses: ClassInfo[];
  onClassChange: (classId: string) => void;
  showAllClassesOption?: boolean;
}
```

## 3. React ContextÂÆüË£Ö

### 3.1 StaffClassContext

#### `reactapp.client/src/contexts/StaffClassContext.tsx`

```typescript
import { createContext, useContext, useState, useEffect, useCallback, ReactNode } from 'react';
import { useAuth } from '../hooks/useAuth';
import { ClassInfo, StaffClassContextType } from '../types/staffClass';

const StaffClassContext = createContext<StaffClassContextType | undefined>(undefined);

interface StaffClassProviderProps {
  children: ReactNode;
}

export function StaffClassProvider({ children }: StaffClassProviderProps) {
  const { user } = useAuth();
  const [currentClass, setCurrentClass] = useState<ClassInfo | null>(null);
  const [availableClasses, setAvailableClasses] = useState<ClassInfo[]>([]);
  const [isLoading, setIsLoading] = useState(false);

  const staffInfo = user?.staff;
  const nurseryId = staffInfo?.nurseryId ?? 0;
  const staffId = staffInfo?.staffId ?? 0;
  const isMultiClass = (availableClasses.length > 1);

  // ÂàùÊúüÂåñ: Ë™çË®ºÊÉÖÂ†±„Åã„Çâ„ÇØ„É©„Çπ‰∏ÄË¶ß„ÇíÂèñÂæó
  useEffect(() => {
    if (staffInfo?.classAssignments) {
      const classes: ClassInfo[] = staffInfo.classAssignments.map(assignment => ({
        classId: assignment.classId,
        className: assignment.className,
        assignmentRole: assignment.assignmentRole,
        nurseryId: staffInfo.nurseryId,
      }));

      setAvailableClasses(classes);

      // Âçò‰∏Ä„ÇØ„É©„Çπ„ÅÆÂ†¥Âêà„ÅØËá™ÂãïÈÅ∏Êäû
      if (classes.length === 1) {
        setCurrentClass(classes[0]);
      } else {
        // Ë§áÊï∞„ÇØ„É©„Çπ„ÅÆÂ†¥Âêà„ÄÅlocalStorage„Åã„ÇâÂæ©ÂÖÉ
        const savedClassId = localStorage.getItem(`lastSelectedClass_${staffId}`);
        const savedClass = classes.find(c => c.classId === savedClassId);
        setCurrentClass(savedClass || null);
      }
    }
  }, [staffInfo, staffId]);

  // „ÇØ„É©„ÇπÂàá„ÇäÊõø„ÅàÂá¶ÁêÜ
  const switchClass = useCallback(async (classId: string) => {
    const targetClass = availableClasses.find(c => c.classId === classId);
    if (!targetClass) {
      console.error(`Class not found: ${classId}`);
      return;
    }

    setCurrentClass(targetClass);

    // localStorage„Å´‰øùÂ≠ò
    localStorage.setItem(`lastSelectedClass_${staffId}`, classId);

    // ToastÈÄöÁü• („Ç™„Éó„Ç∑„Éß„É≥)
    console.log(`„ÇØ„É©„Çπ„Çí${targetClass.className}„Å´Âàá„ÇäÊõø„Åà„Åæ„Åó„Åü`);
  }, [availableClasses, staffId]);

  // „ÇØ„É©„Çπ‰∏ÄË¶ß„ÅÆÂÜçÂèñÂæó (API„Åã„ÇâÊúÄÊñ∞ÊÉÖÂ†±„ÇíÂèñÂæó)
  const refreshClasses = useCallback(async () => {
    if (!staffInfo) return;

    setIsLoading(true);
    try {
      const response = await fetch('/api/staff/classes', {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('accessToken')}`,
        },
      });

      if (response.ok) {
        const data = await response.json();
        const classes: ClassInfo[] = data.data.classes.map((c: any) => ({
          classId: c.classId,
          className: c.className,
          assignmentRole: c.assignmentRole,
          nurseryId: c.nurseryId,
        }));

        setAvailableClasses(classes);

        // ÁèæÂú®„ÅÆ„ÇØ„É©„Çπ„ÅåÂâäÈô§„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„É™„Çª„ÉÉ„Éà
        if (currentClass && !classes.find(c => c.classId === currentClass.classId)) {
          setCurrentClass(null);
        }
      }
    } catch (error) {
      console.error('Failed to refresh classes:', error);
    } finally {
      setIsLoading(false);
    }
  }, [staffInfo, currentClass]);

  const value: StaffClassContextType = {
    nurseryId,
    staffId,
    currentClass,
    availableClasses,
    isMultiClass,
    isLoading,
    switchClass,
    refreshClasses,
  };

  return (
    <StaffClassContext.Provider value={value}>
      {children}
    </StaffClassContext.Provider>
  );
}

export function useStaffClass() {
  const context = useContext(StaffClassContext);
  if (context === undefined) {
    throw new Error('useStaffClass must be used within StaffClassProvider');
  }
  return context;
}
```

## 4. „Ç≥„É≥„Éù„Éº„Éç„É≥„ÉàÂÆüË£Ö

### 4.1 ClassSelector„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà

#### `reactapp.client/src/components/staff/ClassSelector.tsx`

```typescript
import { Fragment } from 'react';
import { Menu, Transition } from '@headlessui/react';
import { ChevronDownIcon } from '@heroicons/react/20/solid';
import { ClassInfo } from '../../types/staffClass';

interface ClassSelectorProps {
  currentClass: ClassInfo | null;
  availableClasses: ClassInfo[];
  onClassChange: (classId: string) => void;
  showAllClassesOption?: boolean;
}

export function ClassSelector({
  currentClass,
  availableClasses,
  onClassChange,
  showAllClassesOption = false,
}: ClassSelectorProps) {
  const getRoleBadge = (role: 'MainTeacher' | 'AssistantTeacher') => {
    return role === 'MainTeacher' ? (
      <span className="ml-2 text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded">‰∏ªÊãÖ‰ªª</span>
    ) : (
      <span className="ml-2 text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded">ÂâØÊãÖ‰ªª</span>
    );
  };

  return (
    <Menu as="div" className="relative inline-block text-left">
      <div>
        <Menu.Button className="inline-flex w-full justify-center gap-x-1.5 rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
          {currentClass ? (
            <>
              üè´ {currentClass.className}
              {getRoleBadge(currentClass.assignmentRole)}
            </>
          ) : (
            '„ÇØ„É©„Çπ„ÇíÈÅ∏Êäû'
          )}
          <ChevronDownIcon className="-mr-1 h-5 w-5 text-gray-400" aria-hidden="true" />
        </Menu.Button>
      </div>

      <Transition
        as={Fragment}
        enter="transition ease-out duration-100"
        enterFrom="transform opacity-0 scale-95"
        enterTo="transform opacity-100 scale-100"
        leave="transition ease-in duration-75"
        leaveFrom="transform opacity-100 scale-100"
        leaveTo="transform opacity-0 scale-95"
      >
        <Menu.Items className="absolute right-0 z-10 mt-2 w-56 origin-top-right rounded-md bg-white shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none">
          <div className="py-1">
            {availableClasses.map((classInfo) => (
              <Menu.Item key={classInfo.classId}>
                {({ active }) => (
                  <button
                    onClick={() => onClassChange(classInfo.classId)}
                    className={`${
                      active ? 'bg-gray-100 text-gray-900' : 'text-gray-700'
                    } ${
                      currentClass?.classId === classInfo.classId ? 'font-bold' : ''
                    } block w-full px-4 py-2 text-left text-sm`}
                  >
                    {classInfo.className}
                    {getRoleBadge(classInfo.assignmentRole)}
                  </button>
                )}
              </Menu.Item>
            ))}

            {showAllClassesOption && availableClasses.length > 1 && (
              <>
                <div className="border-t border-gray-100 my-1" />
                <Menu.Item>
                  {({ active }) => (
                    <button
                      onClick={() => onClassChange('all')}
                      className={`${
                        active ? 'bg-gray-100 text-gray-900' : 'text-gray-700'
                      } block w-full px-4 py-2 text-left text-sm`}
                    >
                      ÂÖ®„ÇØ„É©„ÇπË°®Á§∫
                    </button>
                  )}
                </Menu.Item>
              </>
            )}
          </div>
        </Menu.Items>
      </Transition>
    </Menu>
  );
}
```

### 4.2 StaffHeader„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà

#### `reactapp.client/src/components/staff/StaffHeader.tsx`

```typescript
import { useStaffClass } from '../../contexts/StaffClassContext';
import { ClassSelector } from './ClassSelector';

export function StaffHeader() {
  const { currentClass, availableClasses, isMultiClass, switchClass } = useStaffClass();

  return (
    <header className="bg-white shadow">
      <div className="mx-auto max-w-7xl px-4 py-4 sm:px-6 lg:px-8">
        <div className="flex items-center justify-between">
          <h1 className="text-2xl font-bold tracking-tight text-gray-900">
            „Çπ„Çø„ÉÉ„Éï„Éù„Éº„Çø„É´
          </h1>

          {isMultiClass && (
            <ClassSelector
              currentClass={currentClass}
              availableClasses={availableClasses}
              onClassChange={switchClass}
            />
          )}

          {!isMultiClass && currentClass && (
            <div className="text-sm text-gray-600">
              üè´ {currentClass.className}
            </div>
          )}
        </div>
      </div>
    </header>
  );
}
```

## 5. ‰ΩøÁî®‰æã

### 5.1 App.tsx„Åß„ÅÆÁµ±Âêà

```typescript
import { StaffClassProvider } from './contexts/StaffClassContext';
import { useAuth } from './hooks/useAuth';

function App() {
  const { user, isAuthenticated } = useAuth();

  return (
    <AuthProvider>
      {isAuthenticated && user?.role === 'Staff' && (
        <StaffClassProvider>
          <StaffHeader />
          <StaffRoutes />
        </StaffClassProvider>
      )}
      {/* Parent routes etc. */}
    </AuthProvider>
  );
}
```

### 5.2 ÁîªÈù¢„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà„Åß„ÅÆ‰ΩøÁî®

```typescript
// „É¨„Éù„Éº„Éà‰ΩúÊàêÁîªÈù¢„Åß„ÅÆ‰ΩøÁî®‰æã
import { useStaffClass } from '../../contexts/StaffClassContext';

export function CreateReportPage() {
  const { currentClass, isMultiClass } = useStaffClass();

  if (isMultiClass && !currentClass) {
    return (
      <div className="text-center py-8">
        <p>„ÇØ„É©„Çπ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
      </div>
    );
  }

  // currentClass„Çí‰ΩøÁî®„Åó„Å¶API„É™„ÇØ„Ç®„Çπ„Éà
  const fetchChildren = async () => {
    const response = await fetch(
      `/api/staff/classes/${currentClass?.classId}/children`,
      {
        headers: {
          'Authorization': `Bearer ${token}`,
          'X-Class-Context': currentClass?.classId || '',
        },
      }
    );
    // ...
  };

  return (
    <div>
      <h2>{currentClass?.className}„ÅÆ„É¨„Éù„Éº„Éà‰ΩúÊàê</h2>
      {/* ... */}
    </div>
  );
}
```

## 6. API„É™„ÇØ„Ç®„Çπ„Éà„Éò„ÉÉ„ÉÄ„Éº

### 6.1 „ÇØ„É©„Çπ„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„Éò„ÉÉ„ÉÄ„Éº

ÂÖ®„Å¶„ÅÆ„Çπ„Çø„ÉÉ„ÉïAPIÂëº„Å≥Âá∫„Åó„Å´‰ª•‰∏ã„ÅÆ„Éò„ÉÉ„ÉÄ„Éº„ÇíÂê´„ÇÅ„Çã:

```typescript
const headers = {
  'Authorization': `Bearer ${accessToken}`,
  'X-Class-Context': currentClass?.classId || '',
  'X-Nursery-Id': nurseryId.toString(),
};
```

### 6.2 Axios Interceptor„Åß„ÅÆËá™Âãï‰ªò‰∏é

```typescript
// reactapp.client/src/services/api.ts
import axios from 'axios';

const api = axios.create({
  baseURL: '/api',
});

// „É™„ÇØ„Ç®„Çπ„Éà„Ç§„É≥„Çø„Éº„Çª„Éó„Çø„Éº
api.interceptors.request.use((config) => {
  const token = localStorage.getItem('accessToken');
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }

  // StaffClassContext„Åã„ÇâÁèæÂú®„ÅÆ„ÇØ„É©„Çπ„ÇíÂèñÂæó„Åó„Å¶‰ªò‰∏é
  const staffContext = localStorage.getItem('currentStaffClass');
  if (staffContext) {
    const { classId, nurseryId } = JSON.parse(staffContext);
    config.headers['X-Class-Context'] = classId;
    config.headers['X-Nursery-Id'] = nurseryId;
  }

  return config;
});

export default api;
```

## 7. „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞

### 7.1 „ÇØ„É©„Çπ„Ç¢„ÇØ„Çª„ÇπÊ®©Èôê„Ç®„É©„Éº

```typescript
// 403 Forbidden„Ç®„É©„ÉºÊôÇ„ÅÆÂá¶ÁêÜ
api.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response?.status === 403) {
      const errorCode = error.response.data?.error?.code;

      if (errorCode === 'CLASS_ACCESS_DENIED') {
        // „ÇØ„É©„ÇπÈÅ∏ÊäûÁîªÈù¢„Å´„É™„ÉÄ„Ç§„É¨„ÇØ„Éà
        window.location.href = '/staff/select-class';
      }
    }
    return Promise.reject(error);
  }
);
```

## 8. „ÉÜ„Çπ„ÉàËÄÉÊÖÆ‰∫ãÈ†Ö

### 8.1 Context„ÅÆ„É¢„ÉÉ„ÇØ

```typescript
// __tests__/components/staff/ClassSelector.test.tsx
import { render, screen } from '@testing-library/react';
import { StaffClassContext } from '../../../contexts/StaffClassContext';
import { ClassSelector } from '../../../components/staff/ClassSelector';

const mockContextValue = {
  nurseryId: 1,
  staffId: 123,
  currentClass: {
    classId: 'sakura',
    className: '„Åï„Åè„ÇâÁµÑ',
    assignmentRole: 'MainTeacher' as const,
    nurseryId: 1,
  },
  availableClasses: [
    {
      classId: 'sakura',
      className: '„Åï„Åè„ÇâÁµÑ',
      assignmentRole: 'MainTeacher' as const,
      nurseryId: 1,
    },
    {
      classId: 'himawari',
      className: '„Å≤„Åæ„Çè„ÇäÁµÑ',
      assignmentRole: 'AssistantTeacher' as const,
      nurseryId: 1,
    },
  ],
  isMultiClass: true,
  isLoading: false,
  switchClass: jest.fn(),
  refreshClasses: jest.fn(),
};

test('displays current class name', () => {
  render(
    <StaffClassContext.Provider value={mockContextValue}>
      <ClassSelector {...mockContextValue} onClassChange={jest.fn()} />
    </StaffClassContext.Provider>
  );

  expect(screen.getByText(/„Åï„Åè„ÇâÁµÑ/)).toBeInTheDocument();
});
```

## 9. „Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÊúÄÈÅ©Âåñ

### 9.1 „É°„É¢Âåñ

```typescript
const ClassSelector = memo(function ClassSelector({
  currentClass,
  availableClasses,
  onClassChange,
}: ClassSelectorProps) {
  // ...
});

export { ClassSelector };
```

### 9.2 localStorage„Ç≠„É£„ÉÉ„Ç∑„É•

„ÇØ„É©„ÇπÂàá„ÇäÊõø„ÅàÊôÇ„Å´localStorage„Å´‰øùÂ≠ò„Åó„ÄÅ„Éö„Éº„Ç∏„É™„É≠„Éº„ÉâÊôÇ„Å´„ÇÇÂæ©ÂÖÉ:

```typescript
// localStorage„Ç≠„Éº: lastSelectedClass_{staffId}
localStorage.setItem(`lastSelectedClass_${staffId}`, classId);
```

## 10. „Ç¢„ÇØ„Çª„Ç∑„Éì„É™„ÉÜ„Ç£

- `aria-label`„ÇíClassSelector„Å´ËøΩÂä†
- „Ç≠„Éº„Éú„Éº„Éâ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ÂØæÂøú (HeadlessUI„ÅåËá™ÂãïÊèê‰æõ)
- „Çπ„ÇØ„É™„Éº„É≥„É™„Éº„ÉÄ„ÉºÂØæÂøú„ÅÆ„É©„Éô„É´‰ªò„Åë

```typescript
<Menu.Button
  aria-label="ÊãÖÂΩì„ÇØ„É©„Çπ„ÇíÈÅ∏Êäû"
  className="..."
>
  {/* ... */}
</Menu.Button>
```
